/*global Backbone:false, $:false, _:false, JST:false, App:false, window:false */
var AcceptanceCriterion=Backbone.Model.extend({Story:function(){return this.collection.story},IsEditable:function(){return this.CanEdit()},IsLocked:function(){return this.collection.story.IsLocked()},CanEdit:function(){return this.collection.story.CanEdit()},CanEditStatus:function(){return this.collection.story.CanEditStatus()},IsDone:function(){return this.collection.story.IsDone()},beforeSave:function(a){this.collection.story.isNew()?(window.console&&console.log("Saving parent Story first"),this.collection.story.save({},{error:function(a,b){var c="Unable to save changes...  Please refresh.";try{c=$.parseJSON(b.responseText).message}catch(d){window.console&&console.log(d)}var e=new App.Views.Error({message:c})},success:function(){a()}})):a()}}),Backlog=Backbone.Model.extend({url:function(){return this.collection.url()+(this.isNew()?"":"/"+(this.get("snapshot_master_id")?this.get("snapshot_master_id")+"/snapshots/":"")+this.id)+"?cache-buster"+Math.floor(Math.random()*1e6)},IsEditable:function(){return this.CanEdit()},IsLocked:function(){return this.get("is_locked")},CanEdit:function(){return this.get("is_editable")?!0:!1},CanEditStatus:function(){return this.get("is_status_editable")?!0:!1},Themes:function(){return this._themes||(this._themes=new ThemesCollection(this.get("themes"),{backlog:this}),this.unset("themes")),this._themes},Sprints:function(){return this._sprints||(this._sprints=new SprintsCollection(this.get("sprints"),{backlog:this}),this.unset("sprints")),this._sprints},Account_ID:function(){return this.collection.account_id}}),Sprint=Backbone.Model.extend({Backlog:function(){return this.collection.backlog},SprintStories:function(){return this._sprint_stories||(this._sprint_stories=new SprintStoriesCollection(this.get("sprint_stories"),{sprint:this}),this.unset("sprint_stories")),this._sprint_stories},IsComplete:function(){return this.get("completed?")},IsEditable:function(){return this.IsComplete()?!1:this.CanEdit()},CanEdit:function(){return this.collection.backlog.CanEdit()},CanEditStatus:function(){return this.collection.backlog.CanEditStatus()}}),SprintStory=Backbone.Model.extend({initialize:function(){App.Collections.SprintStoryStatuses||(App.Collections.SprintStoryStatuses=new SprintStoryStatusesCollection,App.Collections.SprintStoryStatuses.fetch()),this.bind("change",function(a){this.Story()&&this.Story().set({sprint_story_status_id:this.get("sprint_story_status_id"),sprint_story_id:this.get("id")})}),this.bind("remove",function(a){this.Story()&&this.Story().set({sprint_story_status_id:-1,sprint_story_id:-1})})},Sprint:function(){return this.collection.sprint},Story:function(){var a=this;if(!this._story){var b=this.Sprint().Backlog().Themes().get(this.get("theme_id"));b?this._story=b.Stories().get(this.get("story_id")):this.Sprint().Backlog().Themes().each(function(b){if(!a._story){var c=b.Stories().get(a.get("story_id"));c&&(a._story=c)}});if(!this._story)throw"Data inconsistency error, story "+this.get("story_id")+" does not exist"}return this._story},Status:function(){return App.Collections.SprintStoryStatuses.get(this.get("sprint_story_status_id"))}}),SprintStoryStatus=Backbone.Model.extend({DoneCode:"D",IsDone:function(){return this.get("code").toUpperCase()==this.DoneCode}}),Story=Backbone.Model.extend({Theme:function(){return this.collection.theme},IsEditable:function(){return this.CanEdit()?!this.IsDone():!1},IsLocked:function(){return this.collection.theme.IsLocked()},CanEdit:function(){return this.collection.theme.CanEdit()},CanEditStatus:function(){return this.collection.theme.CanEditStatus()},IsDone:function(){var a=this.SprintStory();return a?a.Status()?a.Status().IsDone():!1:!1},AcceptanceCriteria:function(){return this._acceptance_criteria||(this._acceptance_criteria=new AcceptanceCriteriaCollection(this.get("acceptance_criteria"),{story:this}),this.unset("acceptance_criteria")),this._acceptance_criteria},MoveToTheme:function(a,b){var c=this;$.post(this.collection.url()+"/"+this.get("id")+"/move-to-theme/"+a).success(function(d,e,f){var g=c.Theme().collection;c.collection.remove(c),g.get(Number(a)).Stories().add(c),c.set(d),c.trigger("change:unique_id"),_.isFunction(b.success)&&b.success(c,f)}).error(function(a,d){window.console&&console.log("Move to theme failed"),_.isFunction(b.error)&&b.error(c,d)})},SprintStory:function(){var a=null,b=this;return this.Theme().Backlog().Sprints().each(function(c){if(a)return;c.SprintStories().each(function(c){!a&&c.get("story_id")===b.get("id")&&(a=c)})}),a}}),Theme=Backbone.Model.extend({Stories:function(){return this._stories||(this._stories=new StoriesCollection(this.get("stories"),{theme:this}),this.unset("stories")),this._stories},Backlog:function(){return this.collection.backlog},IsEditable:function(){return this.CanEdit()},IsLocked:function(){return this.collection.backlog.IsLocked()},CanEdit:function(){return this.collection.backlog.CanEdit()},CanEditStatus:function(){return this.collection.backlog.CanEditStatus()},ReNumberStories:function(a){var b=this;$.post(this.collection.url()+"/"+this.get("id")+"/re-number-stories").success(function(c,d,e){b.Stories().each(function(a){a.fetch()}),_.isFunction(a.success)&&a.success(b,e)}).error(function(b){window.console&&console.log("Renumber stories failed"),_.isFunction(a.error)&&a.error(b)})}}),AcceptanceCriteriaCollection=Backbone.Collection.extend({model:AcceptanceCriterion,story:null,url:function(){if(!!this.story&&!!this.story.get("id"))return"/stories/"+this.story.get("id")+"/acceptance_criteria";var a=new App.Views.Error({message:"Error, missing necessary data ID to display Acceptance Criteria"})},initialize:function(a,b){this.story=b?b.story:null,_.bindAll(this,"saveOrder")},saveOrder:function(a){var b=this;_.each(a,function(c,d){var e=b.get(d);e&&(e.set({position:a[d]}),e.save(!1,{error:function(){var a=new App.Views.Error({message:"Error, could not save the new order of criteria"})}}))})}}),BacklogsCollection=Backbone.Collection.extend({model:Backlog,account_id:null,url:function(){if(!!this.account_id)return"/accounts/"+this.account_id+"/backlogs";var a=new App.Views.Error({message:"Error, missing necessary Account ID to display Backlog"})},initialize:function(a,b){this.account_id=b?b.account_id:null}}),SprintStoriesCollection=Backbone.Collection.extend({model:SprintStory,sprint:null,url:function(){if(!!this.sprint)return"/sprints/"+this.sprint.get("id")+"/sprint-stories";var a=new App.Views.Error({message:"Error, cannot find Sprint and thus cannot load SprintStory"})},initialize:function(a,b){this.sprint=b?b.sprint:null},getByStoryId:function(a){var b=null;return this.each(function(c){Number(c.get("story_id"))===Number(a)&&(b=c)}),b},batchUpdatePosition:function(a,b){var c="/sprints/"+this.sprint.get("id")+"/sprint-stories/update-order",d=this;b=b||{},data=_(a).map(function(a,b){return"ids["+b+"]="+a}).join("&"),$.ajax(c,{success:function(a){_(a).each(function(a){d.get(a.id).set(a)}),b.success&&b.success.apply(this,arguments)},error:function(){b.error&&b.error.apply(this,arguments)},data:data,dataType:"json",type:"PUT"})},incompleteStories:function(){return this.filter(function(a){return a.Story().IsEditable()})}}),SprintStoryStatusesCollection=Backbone.Collection.extend({model:SprintStoryStatus,url:"/sprint-story-statuses"}),SprintsCollection=Backbone.Collection.extend({model:Sprint,backlog:null,url:function(){if(!!this.backlog)return"/backlogs/"+this.backlog.get("id")+"/sprints";var a=new App.Views.Error({message:"Error, missing necessary Backlog ID to display Sprint"})},initialize:function(a,b){this.backlog=b?b.backlog:null}}),StoriesCollection=Backbone.Collection.extend({model:Story,theme:null,url:function(){if(!!this.theme&&!!this.theme.get("id"))return"/themes/"+this.theme.get("id")+"/stories";var a=new App.Views.Error({message:"Error, missing necessary data ID to display Story"})},initialize:function(a,b){this.theme=b?b.theme:null},saveOrder:function(a){var b=this;_.each(a,function(c,d){var e=b.get(d);e&&(e.set({position:a[d]}),e.save())})}}),ThemesCollection=Backbone.Collection.extend({model:Theme,backlog:null,url:function(){if(!!this.backlog)return"/backlogs/"+this.backlog.get("id")+"/themes";var a=new App.Views.Error({message:"Error, cannot find Backlog and thus cannot load Theme"})},initialize:function(a,b){this.backlog=b?b.backlog:null},saveOrder:function(a){var b=this;_.each(a,function(c,d){var e=b.get(d);e&&(e.set({position:a[d]}),e.save())})}});App.Controllers.Statistics={updateStatistics:function(a){if(!_.isEmpty(a)){var b=App.Collections.Backlogs.last(),c=_.clone(a);delete c.themes,b.set(c),b.trigger("statisticsUpdated"),_.each(a.themes,function(a){var c=b.Themes().get(a.theme_id);c&&(c.set(a),c.trigger("statisticsUpdated"))})}}},App.Views.SharedSprintSettings={formValidationConfig:{rules:{start_on:{required:!0},duration_days:{required:!0,digits:!0,min:1},number_team_members:{number:!0,min:0},explicit_velocity:{number:!0,min:1}},messages:{start_on:{required:"Date&nbsp;missing"},duration_days:{required:"Sprint duration is required",digits:"Enter a value using whole numbers",min:"Sprint duration must be at least 1 day"},number_team_members:{required:"Team size is required",min:"Team size must be greater than 0",number:"Team size must be a valid number"},explicit_velocity:{required:"Velocity is required",number:"Velocity must be a valid number",min:"Velocity must be at least 1"}}},addFormBehaviour:function(a,b){var c=!1,d=function(){a.find("tr").removeClass("disabled").find("input").removeAttr("disabled"),a.find("#explicit-velocity, #number-team-members").rules("add",{required:!1}),a.find("#use-team-members").is(":checked")?(a.find("tr.use-explicit-velocity").addClass("disabled").find("input").attr("disabled","true"),c?a.find("#use-explicit-velocity-container").slideUp():(a.find("#use-explicit-velocity-container").hide(),c=!0),a.find("#use-team-members-container").slideDown(),a.find("#number-team-members").rules("add",{required:!0}),a.find("label#use-explicit-velocity-false").addClass("selected"),a.find("label#use-explicit-velocity-true").removeClass("selected")):(a.find("tr.use-team-members").addClass("disabled").find("input").attr("disabled","true"),a.find("#explicit-velocity").rules("add",{required:!0}),c?a.find("#use-team-members-container").slideUp():(a.find("#use-team-members-container").hide(),c=!0),a.find("#use-explicit-velocity-container").slideDown(),a.find("label#use-explicit-velocity-true").addClass("selected"),a.find("label#use-explicit-velocity-false").removeClass("selected"))},e=function(){var c;isNaN(parseFloat(a.find("#number-team-members").val()))?a.find("#expected-velocity").text("(enter your team size)"):isNaN(parseFloat(a.find("#duration-days").val()))?a.find("#expected-velocity").text("(enter duration of sprint)"):(c=parseFloat(a.find("#number-team-members").val())*parseFloat(a.find("#duration-days").val())*b,a.find("#expected-velocity").text(c===1?niceNum(c)+" point":niceNum(c)+" points"))};b&&!a.find("#explicit-velocity").val()?a.find("#use-team-members").attr("checked",!0):a.find("#use-explicit-velocity").attr("checked",!0),a.find("#use-team-members, #use-explicit-velocity").change(d),d(),a.find("#duration-days, #number-team-members").keyup(e),e()}},App.Views.Helpers={scrollIntoBacklogView:function(a,b){if($(a).length){var c=$(window).scrollTop(),d=$(a).offset().top,e=100,f=this.bufferTop?this.bufferTop:this.bufferTop=$("#backlog-container").offset().top,g=!1;d<c+f?g=d-f:d>c+$(window).height()-e&&(g=d-$(window).height()+e),g?$("html:not(:animated),body:not(:animated)").animate({scrollTop:g},"fast",null,function(){_.isFunction(b)&&b(a)}):_.isFunction(b)&&b(a)}else _.isFunction(b)&&b(a)},setStatusHover:function(){$(this.el).find(".status .tab").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})},statusChangeClick:function(a){var b=this,c=$(JST["templates/stories/status-drop-down"]({model:this.model}));a.preventDefault(),a.stopPropagation(),this.model.CanEditStatus()?this.model.SprintStory().Sprint().IsComplete()?new App.Views.Warning({message:"You cannot change the status of this story as it's assigned to a completed sprint"}):($("body").find("#sprint-story-status-dropdown").remove(),$("body").append(c),c.find("li").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")}),c.width()<$(this.el).find(".status .tab").outerWidth()&&c.css("width",$(this.el).find(".status .tab").outerWidth()+"px"),c.css("position","absolute").position({of:$(this.el).find(".status .tab"),my:"center top",at:"center bottom",offset:"0 0"}),$("html").bind("click.status-drop-down",function(){$("body").find("#sprint-story-status-dropdown").remove(),$("html").unbind("click.status-drop-down")}),c.find("li").click(function(a){a.preventDefault(),a.stopPropagation(),$(a.target).trigger("statusChanged");var c=$(this).attr("id").replace("status-id-",""),d=$(this).attr("class").match(/status-code-(\w+)/)[1],e=$(this).text();$("body").find("#sprint-story-status-dropdown").remove(),$("html").unbind("click.status-drop-down"),App.Views.Helpers.statusDropDownChanged.call(b,c,d,e)})):new App.Views.Warning({message:"You do not have permission to update the status of stories for this backlog"})},statusDropDownChanged:function(a,b,c){var d=this;$(this.el).find(".status .tab").attr("class","tab status-code-"+b).removeClass("hover").find("span").text(c),b===this.model.SprintStory().Status().DoneCode?$(this.el).addClass("locked"):$(this.el).removeClass("locked"),this.model.SprintStory().set({sprint_story_status_id:Number(a)}),this.model.SprintStory().save(!1,{success:function(a){d.model.SprintStory().Sprint().set(a.get("sprint_statistics")),d.parentView&&d.parentView.updateStatistics(a.get("sprint_statistics"))},error:function(a,b){var c="we've got a problem on our side";try{c=$.parseJSON(b.responseText).message}catch(d){window.console&&console.log(d)}var e=new App.Views.Error({message:"Oops, "+c+".  Please refresh your browser"})}})},activateUrlify:function(a){var b=this;$(a).find("a.urlified").live("mouseover",function(a){b.linkHelper&&b.linkHelper.remove(),b.linkRolloutTimeout&&clearTimeout(b.linkRolloutTimeout);var c=$("<div>").html($(this).attr("href")).text(),d=c;d.match(/^[\-;&=\+\$,\w]+@/)&&(d="mailto:"+d),d.match(/^www\./)&&(d="http://"+d);var e=$("<a>").attr("href",d).text(c);d.match(/^mailto:/i)||e.attr("target","_blank"),b.linkHelper=$('<div class="link-helper">').text("Go to link: ").append(e),$("body").append(b.linkHelper),b.linkHelper.position({of:$(this),my:"right top",at:"right bottom",offset:"0 0"}),$(b.linkHelper).children().andSelf().mouseover(function(){b.linkRolloutTimeout&&(clearTimeout(b.linkRolloutTimeout),b.linkRolloutTimeout=!1)}).mouseout(function(){b.linkRolloutTimeout&&clearTimeout(b.linkRolloutTimeout),b.linkRolloutTimeout=setTimeout(function(){b.linkHelper.remove()},100)})}).live("mouseout",function(a){b.linkRolloutTimeout=setTimeout(function(){b.linkHelper.remove()},150)}).live("click",function(a){a.preventDefault(),b.linkRolloutTimeout&&clearTimeout(b.linkRolloutTimeout),b.linkHelper&&b.linkHelper.remove()})},addUseOptions:function(a,b){return _(a).extend({use5090Estimates:b.use5090Estimates,useCostEstimates:b.useCostEstimates,useDaysEstimates:b.useDaysEstimates})},setStoryColor:function(a,b){var c=b.match(/^#/)?b.substring(1):b,d="#"+c,e=c.match(/[\d\w]{2}/g),f="0 0 3px 1px rgba("+parseInt(e[0],16)+", "+parseInt(e[1],16)+", "+parseInt(e[2],16)+", 0.35)";return c.toLowerCase()==="ffffff"?(c=d="",$(a).css("background-color","transparent")):$(a).css("background-color","rgba("+parseInt(e[0],16)+", "+parseInt(e[1],16)+", "+parseInt(e[2],16)+", 0.15)"),$(a).find(".background-color-indicator").css("background-color",d),$(a).is(".story-card")&&($(a).css("border-color",d),$(a).css("box-shadow",f).css("-moz-box-shadow",f).css("-webkit-box-shadow",f).css("-o-box-shadow",f)),c}},App.Views.BaseView=Backbone.View.extend({defaultEditableOptions:{placeHolder:'<span class="editable-blank">[edit]</span>',type:"text",zIndex:3},initialize:function(){this.model=this.options.model,this.parentView=this.options.parentView,this.beforeChangeValue={},_.bindAll(this,"beforeChange","contentUpdated");if(this.changeEvent){_.bindAll(this,"changeEvent");var a=this.changeEvent;this.model.bind("all",function(b){a(b,this)})}this.updateStatistics&&(_.bindAll(this,"updateStatistics"),this.model.bind("statisticsUpdated",this.updateStatistics))},beforeChange:function(a,b){var c=$(b).parent().attr("class").replace(/\-/g,"_");return this.beforeChangeValue[c]=a,a},contentUpdated:function(a,b){var c=$(b).parent().attr("class").replace(/\-/g,"_"),d=$(b),e=this.beforeChangeValue[c],f=this;if(a!=e){window.console&&console.log("value for "+c+" has changed from: "+this.beforeChangeValue[c]+" to: "+a);var g={};g[c]=a,this.model.set(g);var h=this.model,i=function(){h.save({},{error:function(a,b){var g="Unable to save changes...";try{g=$.parseJSON(b.responseText).message,g.match(/^Score 50(.*), Score 90(?:\1)$/)&&(g="Score "+g.match(/^Score 50(.*), Score 90(?:\1)$/)[1])}catch(i){window.console&&console.log(i)}var j=new App.Views.Error({message:g});d.text(_.isEmpty(e)?"[edit]":e);var k={};k[c]=_.isEmpty(e)?null:e,h.set(k),c=="code"&&f.model.Stories().each(function(a,b){a.trigger("change:unique_id")})}})};this.model.beforeSave?this.model.beforeSave(i):i()}return a},remove:function(a){a.preventDefault();var b=this;return b.model.isNew()?(b.model.collection.remove(b.model),$(b.el).slideUp("fast",function(){$(b.el).remove()})):($("#dialog-delete").remove(),$("body").append(JST[this.deleteDialogTemplate]({model:this.model})),$("#dialog-delete").dialog({resizable:!1,height:170,modal:!0,buttons:{Delete:function(){b.deleteAction(this,b)},Cancel:function(){$(this).dialog("close")}}})),!1}}),App.Views.AcceptanceCriteria={Index:Backbone.View.extend({tagName:"div",className:"acceptance-criteria",childId:function(a){return"acceptance-criteria-"+a.get("id")},events:{"click li.new-acceptance-criterion div":"createNew"},initialize:function(){this.collection=this.options.collection,_.bindAll(this,"orderChanged","displayOrderIndexes")},render:function(){var a=this;$(this.el).html(JST["templates/acceptance_criteria/index"]({collection:this.collection.models})),this.collection.each(function(b){var c=new App.Views.AcceptanceCriteria.Show({model:b,id:a.childId(b),parentView:a});a.$("ul").append(c.render().el)});if(this.collection.story.IsEditable()){this.$("ul").append(JST["templates/acceptance_criteria/new"]());var b=this.orderChanged;this.$("ul.acceptance-criteria").sortable({start:function(b,c){a.$("textarea, input").blur()},stop:function(a,c){b()},placeholder:"target-order-highlight",axis:"y",handle:".index, .cross-hair-indicator"}).find(".index").disableSelection()}return this.hideEditIfCriteriaExist(),this.displayOrderIndexes(),this},createNew:function(a){a.preventDefault();var b=this.$("li.criterion:last"),c=new AcceptanceCriterion,d=this;this.collection.add(c);var e=(new App.Views.AcceptanceCriteria.Show({model:c,parentView:this})).render().el;this.hideEditIfCriteriaExist(!0),b.find(".data textarea").length&&b.find(".data textarea").val()===""?_.delay(function(){d.$("ul li:last").before(e),d.displayOrderIndexes(),App.Views.Helpers.scrollIntoBacklogView($(e).find(".data"),function(){$(e).find(".data").click()})},150):(this.$("ul li:last").before(e),this.displayOrderIndexes(),this.$("ul li.criterion:last").css("display","none").slideDown(100,function(){App.Views.Helpers.scrollIntoBacklogView($(e).find(".data"),function(){$(e).find(".data").click()})}))},orderChanged:function(){var a={};this.$("li.criterion").each(function(b,c){var d=_.last($(c).attr("id").split("-"));a[d]=b+1}),window.console&&console.log("Order changed and saving - "+JSON.stringify(a)),this.collection.saveOrder(a),this.displayOrderIndexes()},displayOrderIndexes:function(){var a=97,b=26;this.$("li.criterion").each(function(c,d){$(d).find(".index").html(String.fromCharCode(a+c%b)+(c<b?"":Math.floor(c/b))+")")})},hideEditIfCriteriaExist:function(a){this.collection.length||a?this.$("li.new-acceptance-criterion").hide():this.$("li.new-acceptance-criterion").show()}}),Show:App.Views.BaseView.extend({tagName:"li",className:"criterion",events:{},initialize:function(a){App.Views.BaseView.prototype.initialize.call(this),this.parentView=a.parentView,_.bindAll(this,"navigateEvent")},render:function(){var a=this;return $(this.el).html(JST["templates/acceptance_criteria/show"]({model:this.model})),this.model.IsEditable()?this.makeFieldsEditable():this.model.IsLocked()||$(this.el).find(">div.data").click(function(){var b=a.model.CanEdit()?"You cannot edit a story that is marked as done":"You do not have permission to edit story criteria for this backlog";new App.Views.Warning({message:b})}),this},changeEvent:function(a,b){a=="change:id"&&$(this.el).attr("id","acceptance-criteria-"+b.get("id"))},makeFieldsEditable:function(){var a=this,b=function(b){var c=this,d=a.model.collection;if(!_.isEmpty(b))return setTimeout(function(){$(c).html(urlify($(c).html(),35))},25),a.contentUpdated(b,this);$(a.el).slideUp("fast",function(){a.model.destroy({error:function(a,b){var c="Unable to delete criteria...  Please refresh.";try{c=$.parseJSON(b.responseText).message}catch(d){window.console&&console.log(d)}var e=new App.Views.Error({message:c})}}),$(a.el).remove(),d.remove(a.model),a.parentView.hideEditIfCriteriaExist(),a.parentView.displayOrderIndexes()})},c=function(b){return unUrlify(this),a.beforeChange($(this).text(),this)},d=_.extend(_.clone(this.defaultEditableOptions),{data:c,noChange:b,type:"textarea",autoResize:!0,displayDelay:40,onKeyDown:a.navigateEvent});$(this.el).find(">div.data").editable(b,d)},navigateEvent:function(a){if(_.include([9,13,27],a.keyCode)&&!a.ctrlKey){$(a.target).blur();try{a.preventDefault()}catch(b){}var c=$(a.target).parents(".data").parent();a.shiftKey?_.first(c)==_.first(c.parent("ul").find("li.criterion"))?App.Views.Helpers.scrollIntoBacklogView($(this.el).parents("li.story").find("div.so-i-can .data"),function(a){a.click()}):App.Views.Helpers.scrollIntoBacklogView(c.prev().find(".data"),function(a){a.click()}):_.first(c)!=_.last(c.parent("ul").find("li.criterion"))?App.Views.Helpers.scrollIntoBacklogView(c.next().find(".data"),function(a){a.click()}):$.trim(this.$("textarea").val())===""?App.Views.Helpers.scrollIntoBacklogView($(this.el).parents("li.story").find("div.comments .data"),function(a){a.click()}):this.parentView.createNew(a)}}})},App.Views.BacklogDataArea={Show:App.Views.BaseView.extend({events:{"click #backlog-data-area .actions #print":"print","click #backlog-data-area a#backlog-settings-link":"backlogSettings"},initialize:function(a){_.bindAll(this,"print","newSnapshot","jumpToSnapshot","compareSnapshot","sprintsChanged"),this.model.Sprints().bind("change:completed_at",this.sprintsChanged)},render:function(){return $("#new-snapshot").click(this.newSnapshot),$("#compare-snapshot").click(this.compareSnapshot),$("select.snapshot-selector").change(this.jumpToSnapshot),this.enableSnapshotsMenu(),this.enableFilterMenu(),this.model.IsEditable()||($(this.el).addClass("not-editable"),$("#backlog-container").addClass("not-editable"),$("#add-sprint").hide()),this},sprintsChanged:function(a){var b=this,c=document.location.pathname.replace("#.*$","");$.get(c+"/snapshots-list-html",!1,function(a){$(".snapshot-menu-container .select, #viewing-snapshot-container .selector").html(a),$("select.snapshot-selector").change(b.jumpToSnapshot)},"html")},backlogSettings:function(a){var b=$(a.target).attr("href"),c=document.location.href.match(/(#[\w\d_-]+)$/);a.preventDefault(),document.location.href=b+(c?c[1]:"")},enableSnapshotsMenu:function(){var a=!1,b=!1,c=function(){a=!1,b||setTimeout(function(){a===!1&&($("#backlog-data-area .snapshot").removeClass("hover"),$("section.for-backlog .snapshot-menu-container").hide())},50)},d=function(){$("#backlog-data-area .snapshot").addClass("hover"),$("section.for-backlog .snapshot-menu-container").show().position({of:$("#backlog-data-area .snapshot"),my:"right top",at:"right bottom",offset:"0 -8"}),a=!0};$("#backlog-data-area .snapshot").mouseover(d).click(d).mouseout(c),$("section.for-backlog .snapshot-menu-container").mouseover(function(){a=!0}).mouseout(c),$(".snapshot-menu-container .select select").click(function(a){b=!b,a.stopPropagation(),b&&$("html").bind("click.snapshotmenu",function(){b=!1,c(),$("html").unbind("click.snapshotmenu")})}).keydown(function(){b=!1})},enableFilterMenu:function(){var a=!1,b=!1,c=function(){a=!1,b||_.delay(function(){a===!1&&($("#backlog-data-area .filter").removeClass("hover"),$("section.for-backlog .filter-container").hide())},50)},d=function(){$("#backlog-data-area .filter").addClass("hover"),$("section.for-backlog .filter-container").show().position({of:$("#backlog-data-area .filter"),my:"right top",at:"right bottom",offset:"0 -8"}),a=!0},e=function(a){var b=App.Collections.Backlogs.at(0),c=$(a.target).is(":checked");c?($(".filter-notifier").slideDown(),$.cookie("filter_completed_stories",!0)):($(".filter-notifier").slideUp(),$.cookie("filter_completed_stories",null)),b.Themes().each(function(a){a.Stories().each(function(a){a.SprintStory()&&a.SprintStory().Status().IsDone()&&(c?$("#story-"+a.get("id")).slideUp():$("#story-"+a.get("id")).slideDown())})})},f=function(a){a.preventDefault();var b=$(".filter-container input[type=checkbox]").removeAttr("checked");e({target:b})};$("#backlog-data-area .filter").mouseover(d).click(d).mouseout(c),$("section.for-backlog .filter-container").mouseover(function(){a=!0}).mouseout(c),$(".filter-container input[type=checkbox]").change(e),$(".filter-notifier a").click(f),$.cookie("filter_completed_stories")&&_.delay(function(){var a=$(".filter-container input[type=checkbox]").attr("checked","checked");e({target:a});var b=$("input[name=value]").parents(".data");b&&($("input[name=value]").blur(),_.delay(function(){b.click()},150))},750)},print:function(a){var b=this;a.preventDefault(),$("#dialog-print").remove(),$("body").append(JST["templates/backlogs/print-dialog"]({backlog:this.model})),$("#dialog-print").dialog({resizable:!1,height:350,width:400,modal:!0,buttons:{Print:function(){var b=$(this).find("#page-size option:selected").attr("id"),c=$(this).find("#fold-side option:selected").attr("id");$.cookie("fold-side-default",c),$.cookie("page-size-default",b);var d=$(a.target).attr("href");d+="?print_scope="+$(this).find("#print-scope option:selected").attr("id")+"&page_size="+b+"&fold_side="+c,document.location.href=d,$(this).find("p.progress-placeholder").html("Please wait, we're preparing your PDF..."),$(this).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Preparing..."),$(this).parent().find(".ui-dialog-buttonset button:nth-child(1)").remove();var e=this;_.delay(function(){$(e).dialog("close")},2e3)},Cancel:function(){$(this).dialog("close")}}})},newSnapshot:function(a){var b=this,c=$(a.target);a.preventDefault(),$("#dialog-create-snapshot").remove(),$("body").append(JST["templates/backlogs/create-snapshot-dialog"]({backlog:this.model})),$("#dialog-create-snapshot").dialog({resizable:!1,height:230,width:350,modal:!0,buttons:{"Create Snapshot":function(){var a=$(this).find("input[type=text]").val();if($.trim(a)==="")$(this).find("div.progress-area label").text("You must name your snapshot to continue."),$(this).find("div.progress-area").addClass("field_with_errors").find("input[type=text]").focus();else{var b=c.attr("href"),d=$("meta[name=csrf-token]").attr("content"),e=$("meta[name=csrf-param]").attr("content"),f=$('<form method="post" action="'+b+'"></form>'),g='<input name="'+e+'" value="'+d+'" type="hidden" />'+'<input name="name" value="'+htmlEncode(a)+'" type="hidden" />';f.hide().append(g).appendTo("body"),f.submit(),$(this).find("div.progress-area").html('Please wait, we\'re creating your snapshot...<br /><br /><span class="progress-icon"></span>'),$(this).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Preparing..."),$(this).parent().find(".ui-dialog-buttonset button:nth-child(1)").remove()}},Cancel:function(){$(this).dialog("close")}}})},jumpToSnapshot:function(a){a.preventDefault();var b=$(a.target).val(),c=$(a.target).hasClass("sprint")||$(a.target).find(":selected").hasClass("sprint"),d=document.location.href.match(/^.*\/accounts\/\d+\/backlogs\/\d+/i)[0];b.match(/^\d+$/)&&(c?d+="/sprint-snapshots/"+b:d+="/snapshots/"+b),$("#loading-new-snapshot").show(),document.location.href=d},compareSnapshot:function(a){var b=this,c=$(a.target);a.preventDefault(),$("#dialog-compare-snapshot").remove(),$("body").append(JST["templates/backlogs/compare-snapshot-dialog"]({snapshot_options:$("select.snapshot-selector").html()}));var d=document.location.pathname.match(/^\/accounts\/\d+\/backlogs\/\d+\/snapshots\/(\d+)/i);d&&$("#dialog-compare-snapshot select#target-snapshot").val($("#dialog-compare-snapshot select#target-snapshot option:first-child").val()),$("#dialog-compare-snapshot").dialog({resizable:!1,height:310,width:400,modal:!0,buttons:{Compare:function(){var a=$(this).find("select#base-snapshot").val(),b=$(this).find("select#target-snapshot").val();if(a==b)$(this).find("div.error-message").html('<p><span class="error-alert ui-icon ui-icon-alert"></span>You cannot compare the same snapshots.  Please make another selection.</p>');else{var c=document.location.pathname.match(/^\/accounts\/\d+\/backlogs/i)[0],d=document.location.pathname.match(/^\/accounts\/\d+\/backlogs\/(\d+)/i)[1],e=c+"/compare/"+(a.match(/^\d+$/)?a:d)+"/"+(b.match(/^\d+$/)?b:d);App.environment==="test"?document.location.href=e:window.open(e,"_newtab"+Math.floor(Math.random()*1e4)),$(this).dialog("close")}},Cancel:function(){$(this).dialog("close")}}})}})},App.Views.BacklogPresence={Show:App.Views.BaseView.extend({presenceServerUrl:window.location.protocol+"//realtime-easybacklog.dotcloud.com/",initialize:function(a){this.userId=Math.floor(Math.random()*1e9).toString(36),this.name=a.name},render:function(){var a=this;return $.support.cors=!0,App.environment!=="test"&&this.model.IsEditable()&&(a.startPolling(),a.closeConnectionOnUnload()),this},ajaxRequest:function(a){var b=this,c={url:b.presenceServerUrl+a.path,data:a.data,crossDomain:!0,async:a.async===!1?!1:!0,success:function(b){a.success&&a.success(b)},error:function(b){a.error&&a.error(b)}};$.browser.msie&&parseInt($.browser.version,10)>=8?(_.extend(c,{type:"GET",cache:!1,dataType:"jsonp"}),$.ajax(c)):(_.extend(c,{type:"POST"}),$.ajax(c))},startPolling:function(){var a=this,b=function(){a.ajaxRequest({path:"poll",data:{id:a.userId,name:a.name,channel:a.model.get("id")},success:function(c){typeof c=="string"&&c.replace(/\s/g,"").length&&(c=JSON.parse(c));if(c&&c.length)if(c.length>1){var d=_(c).reject(function(b){return b.id===a.userId});d=_.uniq(_.map(d,function(a){return a.name})),$(a.el).html(JST["templates/backlogs/presence"]({people:d})),$(a.el).show()}else $(a.el).is(":visible")&&$(a.el).hide();b()},error:function(a){a.status===410?window.console&&console.log("Connection closed upon request"):setTimeout(b,5e3)}})};b()},closeConnectionOnUnload:function(){var a=this;window.onbeforeunload=function(){a.ajaxRequest({path:"close",data:{id:a.userId,channel:a.model.get("id")},async:!1,success:function(a){window.console&&console.log("Connection close request sent")},error:function(a){window.console&&console.log("Connection close request FAILED")}})}}})},App.Views.BacklogSettings={Show:App.Views.BaseView.extend({tagName:"section",className:"content",stateHtml:!1,initialize:function(){App.Views.BaseView.prototype.initialize.call(this),this.sprintTabsView=this.options.sprintTabsView,_.bindAll(this,"storeBacklogSettings","retrieveBacklogSettings","deleteSprint","storeState","stateChanged","restoreState","updateSprint","cancel")},render:function(){return this.model.get("iteration")==="Backlog"?(this.retrieveBacklogSettings(),App.Views.BacklogCreateUpdateMethods.initializeManageBacklog(),this.el=$("section.content .backlog-settings-body")):(this.storeBacklogSettings(),$("section.title h1").html("Sprint "+this.model.get("iteration")+" settings"),$("section.side-panel").html(JST["templates/sprints/sprint-delete-panel"]({model:this.model})),$("section.side-panel a.delete-sprint").click(this.deleteSprint),this.el=$("section.content .backlog-settings-body").html(JST["templates/sprints/edit-sprint"]({model:this.model,backlog:this.model.Backlog()})),this.$("#start-on").datepicker().datepicker("setDate",parseRubyDate(this.model.get("start_on"))),this.$("a#sprint_submit").click(this.updateSprint),this.$("a#sprint_cancel").click(this.cancel),this.disableFieldsIfNotEditable(),this
.$("form").validate(App.Views.SharedSprintSettings.formValidationConfig),App.Views.SharedSprintSettings.addFormBehaviour(this.$("form"),this.model.Backlog().get("velocity"))),this.storeState(),this},storeState:function(){this.stateHtml=$(this.el).clone()},stateChanged:function(){return!this.stateHtml||haveFormElementValuesChanged(this.el,this.stateHtml)},restoreState:function(){$(this.el).replaceWith(this.stateHtml)},storeBacklogSettings:function(){App.Views.BacklogSettings.fragments||(App.Views.BacklogSettings.fragments={"section.title .heading":!1,"section.side-panel":!1,"section.main-content-pod .backlog-settings-body":!1},_(App.Views.BacklogSettings.fragments).each(function(a,b){App.Views.BacklogSettings.fragments[b]=$(b).clone()}))},retrieveBacklogSettings:function(){App.Views.BacklogSettings.fragments&&_(App.Views.BacklogSettings.fragments).each(function(a,b){$(b).replaceWith(App.Views.BacklogSettings.fragments[b])}),delete App.Views.BacklogSettings.fragments},deleteSprint:function(a){var b=this;a.preventDefault(),$("#dialog-delete-sprint").remove(),$("body").append(JST["templates/sprints/delete-sprint-dialog"]({iteration:this.model.get("iteration")})),$("#dialog-delete-sprint").dialog({resizable:!1,height:170,modal:!0,buttons:{Delete:function(){var a=this;$(this).find(">p").html('Deleting sprint, please wait<br /><br /><span class="progress-icon"></span>'),$(this).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Close"),$(this).parent().find(".ui-dialog-buttonset button:nth-child(1)").remove(),b.model.destroy({success:function(){new App.Views.Notice({message:"Sprint number "+b.model.get("iteration")+" has been deleted"}),b.sprintTabsView.destroy(b.model,function(){$(a).dialog("close")})},error:function(b,c){var d;try{d=JSON.parse(c.responseText).message}catch(e){}d?new App.Views.Error({message:d}):new App.Views.Error({message:"Internal error, unable to delete sprint"}),$(a).dialog("close")}})},Cancel:function(){$(this).dialog("close")}}})},updateSprint:function(a){var b=this;a.preventDefault(),this.$("form").valid()?this.model.IsComplete()?this.$("#sprint_status_completed").is(":checked")?new App.Views.Warning({message:"Nothing has changed so nothing has been updated"}):(this.model.set({completed:"false"}),this.saveSprintFields()):(this.model.set({start_on:$.datepicker.formatDate("yy-mm-dd",this.$("#start-on").datepicker("getDate")),duration_days:this.$("#duration-days").val()}),!this.model.Backlog().get("velocity")||this.$("#use-explicit-velocity").is(":checked")?this.model.set({explicit_velocity:this.$("#explicit-velocity").val(),number_team_members:null}):this.model.set({explicit_velocity:null,number_team_members:this.$("#number-team-members").val()}),this.$("#sprint_status_completed").is(":checked")?this.saveSprintFields(function(){b.saveSprintFields(function(){b.model.set({completed:"true"}),b.saveSprintFields()})}):this.saveSprintFields()):b.$("#form-errors").addClass("form_errors").html("Oops, we could not update the sprint as it looks like you haven't filled in everything correctly.  Please correct the fields marked in red to continue.").hide().slideDown()},saveSprintFields:function(a){var b=this;this.model.save(!1,{success:function(){_.isFunction(a)?a():(new App.Views.Notice({message:"Sprint number "+b.model.get("iteration")+" has been updated"}),b.$("#form-errors").removeClass("form_errors"),b.storeState(),b.disableFieldsIfNotEditable())},error:function(a,c){var d,e;window.console&&console.log(JSON.stringify(c));try{e=JSON.parse(c.responseText).message}catch(f){}e?(b.$("#form-errors").addClass("form_errors").html("Oops, we could not update the sprint as it looks like you haven't filled in everything correctly:<br/>"+e.replace("Validation failed: Completed at ","")).hide().slideDown(),d=new App.Views.Warning({message:"Sprint was not updated.  Please address problems and try again"})):d=new App.Views.Error({message:"An internal error occured and the sprint was not updated.  Please refresh your browser"})}})},disableFieldsIfNotEditable:function(){this.model.IsEditable()||(this.$("#number-team-members, #start-on, #duration-days, #explicit-velocity, input[name=calculation_method]").attr("disabled",!0),this.model.CanEdit()||this.$("input[type=radio][name=sprint_status]").attr("disabled",!0))},cancel:function(a){a.preventDefault(),document.location.href=$("#back-to-backlog").attr("href")}})},App.Views.BacklogStats={Show:App.Views.BaseView.extend({events:{"click a#stats-backlog-settings-change":"backlogSettings","click input#show-projected":"burnDownProjectedCheckboxClicked"},initialize:function(){App.Views.BaseView.prototype.initialize.call(this)},render:function(){var a=this;return $(this.el).html(JST["templates/backlogs/sprint-progress-stats"]({model:this.model})),$("#backlog-data-area .backlog-stats").html(""),a.waitUntilChartsLoaded(function(){a.showCharts()}),this},activated:function(){$("#backlog-data-area .backlog-stats").html(""),this.$(".loading").show(),this.$(".stats").hide(),this.$(".no-stats").hide(),this.$(".no-points").hide(),this.showCharts()},waitUntilChartsLoaded:function(a,b){var c=250,d=this;b||(b=1),window.Highcharts?a():b*c>1e4?new App.Views.Error({message:"Internal error, could not load charting libraries.  Please refresh your browser."}):setTimeout(function(){d.waitUntilChartsLoaded(a,b+1)},c)},showCharts:function(){var a=this;this.model.Sprints().select(function(a){return a.IsComplete()}).length>0?$.getJSON("/backlogs/"+this.model.get("id")+"/backlog-stats").success(function(b){a.$(".loading").hide(),a.$(".no-stats").hide(),b.zero_points?(a.$(".no-points").show(),a.$(".stats").hide()):(a.$(".stats").show(),a.$(".no-points").hide(),$.cookie("stats_show_projected")==="no"?a.$("#show-projected").removeAttr("checked"):a.$("#show-projected").attr("checked","checked"),a.displayBurnDown(b.burn_down),a.displayBurnUp(b.burn_up),a.displayVelocityCompleted(b.velocity_completed),a.displayVelocityStats(b.velocity_stats),$(a.el).trigger("renderingCharts"))}).error(function(a){new App.Views.Error({message:'Unfortunately there has been an internal error loading your statistics.  Please refresh this page or report this error using the "feedback" button on the bottom right of this page.'})}):(this.$(".loading").hide(),this.$(".stats").hide(),this.$(".no-points").hide(),this.$(".no-stats").show())},backlogSettings:function(a){a.preventDefault(),document.location.href=$("#backlog-data-area a:last").attr("href")},displayBurnDown:function(a){this.burnDownChart=new Highcharts.Chart({chart:{renderTo:"burn-down-chart",type:"line"},title:{text:"Burn down",style:{fontSize:"20px",color:"#000000"}},xAxis:{type:"datetime",dateTimeLabelFormats:{month:"%e %b",year:"%b"}},yAxis:{title:{text:"Points"},min:0},colors:["#0000FF","#009900","#FF0000"],tooltip:{formatter:function(){var b,c=this,d,e,f,g=this.series.name,h;switch(g){case"Trend":b=a.trend,e="expected";break;case"Projected":b=a.projected,e="projected";break;case"Actual":b=a.actual,e="completed"}return d=_(b).find(function(a){return c.x===parseRubyDate(a.completed_on).getTime()}),b===a.projected&&d===a.projected[0]&&(b=a.actual,e="completed",d=_(a.actual).last(),g="Actual"),f=function(a){return Number(a)===1?"":"s"},round=function(a){return Math.max(0,Math.round(a*10)/10)},h="<b>"+g,d.iteration===0?h+=" - Sprint 0</b> (Project start)<br/>Project started on "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(d.starts_on))+"<br/>"+round(this.y)+" points remaining":(h+=" - Sprint "+d.iteration+"</b><br/>"+"Sprint "+d.iteration+" finished, "+e+" "+round(d.completed)+" point"+f(d.completed)+"<br/>"+round(this.y)+" points remaining",g==="Actual"&&d.actual&&(h+="<br/>Actual velocity per day per person: "+round(d.actual)),d.team?h+="<br/>"+niceNum(d.team)+" team member"+f(d.team)+" for "+round(d.duration)+" day"+f(d.duration):h+="<br/>Sprint duration: "+round(d.duration)+" day"+f(d.duration),h+="<br/>Dates: "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(d.starts_on))+" - "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(d.completed_on))),h}},series:[{name:"Trend",data:_(a.trend).map(function(a){return[parseRubyDate(a.completed_on).getTime(),Number(a.points)]})},{name:"Projected",data:_(a.projected).map(function(a){return[parseRubyDate(a.completed_on).getTime(),Number(a.points)]}),dashStyle:"LongDash"},{name:"Actual",data:_(a.actual).map(function(a){return[parseRubyDate(a.completed_on).getTime(),Number(a.points)]})}]}),this.showOrHideBurnDownProjected()},burnDownProjectedCheckboxClicked:function(){$.cookie("stats_show_projected",this.$("#show-projected").is(":checked")?"yes":"no"),this.showOrHideBurnDownProjected()},showOrHideBurnDownProjected:function(){this.$("#show-projected").is(":checked")?this.burnDownChart.series[1].show():this.burnDownChart.series[1].hide()},displayBurnUp:function(a){chart1=new Highcharts.Chart({chart:{renderTo:"burn-up-chart",type:"area"},title:{text:"Burn up",style:{fontSize:"20px",color:"#000000"}},xAxis:{type:"datetime",dateTimeLabelFormats:{month:"%e %b",year:"%b"}},yAxis:{title:{text:"Points"}},colors:["#0000FF","#FF0000"],tooltip:{formatter:function(){var b,c=this,d,e,f=this.series.name,g,h;switch(f){case"Actual":b=a.actual;break;case"Total":b=a.total}return d=_(b).find(function(a){return c.x===parseRubyDate(a.starts_on).getTime()}),e=function(a){return Number(a)===1?"":"s"},round=function(a){return Math.max(0,Math.round(a*10)/10)},g="<b>"+f,d.iteration===0?(h=b[b.length-2],g+=" - end of sprint "+h.iteration+"</b><br/>"+"Sprint ended on "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(h.completed_on))+"<br/>",f==="Actual"?g+="Completed "+round(d.total_points)+" point"+e(d.total_points):g+="Total points to complete: "+round(this.y)):(g+=" - Sprint "+d.iteration+"</b><br/>",f==="Actual"?(g+=round(d.total_points)+" point"+e(d.total_points)+" completed at the start"+"<br/>Velocity this sprint: "+round(d.completed)+" point"+e(d.completed),d.actual?g+="<br/>Velocity per day per person: "+round(d.actual)+"<br/>"+niceNum(d.team)+" team member"+e(d.team)+" for "+round(d.duration)+" day"+e(d.duration):g+="<br/>Sprint duration: "+round(d.duration)+" day"+e(d.duration)):g+="Total points to complete: "+round(this.y),g+="<br />Dates: "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(d.starts_on))+" - "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(d.completed_on))),g}},series:[{name:"Total",data:_(a.total).map(function(a){return[parseRubyDate(a.starts_on).getTime(),Number(a.total_points)]})},{name:"Actual",data:_(a.actual).map(function(a){return[parseRubyDate(a.starts_on).getTime(),Number(a.total_points)]})}]})},displayVelocityCompleted:function(a){chart1=new Highcharts.Chart({chart:{renderTo:"velocity-chart",type:"column"},title:{text:"Velocity of completed sprints",style:{fontSize:"20px",color:"#000000"}},xAxis:{categories:_(a).map(function(a){return"Sprint "+a.iteration})},yAxis:{title:{text:"Points"}},colors:["#0000FF"],tooltip:{formatter:function(){var b=this,c,d,e;return c=_(a).find(function(a){return b.x==="Sprint "+a.iteration}),d=function(a){return Number(a)===1?"":"s"},round=function(a){return Math.max(0,Math.round(a*10)/10)},e="<b>Sprint "+c.iteration+"</b><br />"+"Completed "+round(c.completed)+" point"+d(c.completed),c.actual?e+="<br/>Actual velocity per day per person: "+round(c.actual)+"<br/>"+niceNum(c.team)+" team member"+d(c.team)+" for "+round(c.duration)+" day"+d(c.duration):e+="<br/>Sprint duration: "+round(c.duration)+" day"+d(c.duration),e+="<br/>Dates: "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(c.starts_on))+" - "+$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(c.completed_on)),e}},series:[{name:"Total",data:_(a).map(function(a){return a.completed})}]})},displayVelocityStats:function(a){var b=a.expected_day,c=a.expected_sprint,d=a.actual_day,e=a.actual_sprint;b?(this.$("#velocity-per-day-average").text(Math.round(d*10)/10),this.$("#velocity-per-day-expected").text(Math.round(b*10)/10),this.$(".stats .average .notice").html("The expected backlog daily velocity is configured as "+(b==1?"1 point":b+" points")+' per day per team member. <br/><a href="#backlog-settings" id="stats-backlog-settings-change">Change backlog settings &raquo;</a>')):(this.$(".average .per-day").hide(),this.$(".stats .average .notice").html('The expected velocity is based on the velocity set up in the most recent sprint. <a href="#backlog-settings" id="stats-backlog-settings-change">Change backlog and sprint settings &raquo;</a>')),this.$("#velocity-per-sprint-average").text(Math.round(e*10)/10),this.$("#velocity-per-sprint-expected").text(Math.round(c*10)/10)}})},App.Views.Backlogs={Show:App.Views.BaseView.extend({dataArea:$("#backlog-data-area"),useOptions:{},initialize:function(a){var b=$("#backlog-container #themes-header .columns");App.Views.BaseView.prototype.initialize.call(this),this.sprintTabsView=a.sprintTabsView,_.bindAll(this,"activated"),this.useOptions={use5090Estimates:b.find(".score-50").length?!0:!1,useCostEstimates:b.find(".cost-formatted").length?!0:!1,useDaysEstimates:b.find(".days-formatted").length?!0:!1}},render:function(){var a=new App.Views.Themes.Index(_.extend({collection:this.model.Themes()},this.useOptions));this.$("#themes-container").html(a.render().el);var b=this;return this.activated(),this},updateStatistics:function(){$("#backlog-data-area .backlog-stats").html(JST["templates/backlogs/stats"](_.extend({model:this.model},this.useOptions))),this.sprintTabsView.adjustTabConstraints(!0)},activated:function(){this.updateStatistics(),this.model.IsEditable()&&setTimeout(function(){var a=$("ul.themes li.theme:first .theme-data .name .data");a.length?a.click():$("ul.themes li.actions a.new-theme").focus()},10)}})},App.Views.Notice=Backbone.View.extend({className:"notice",displayLength:5e3,defaultMessage:"",initialize:function(){_.bindAll(this,"render"),this.message=this.options.message||this.defaultMessage,this.render()},render:function(){var a=this;return $(this.el).html(this.message),$(this.el).hide(),$("#alert-space").html(this.el),$(this.el).slideDown(),_.delay(function(){$(a.el).slideUp(),_.delay(function(){a.remove()},100)},this.className=="notice"?this.displayLength:this.displayLength*2),this}}),App.Views.Error=App.Views.Notice.extend({className:"error",defaultMessage:"Uh oh! Something went wrong. Please try again."}),App.Views.Warning=App.Views.Notice.extend({className:"warning",defaultMessage:"Unfortunately we could not perform that action."}),App.Views.SprintTabs={Index:App.Views.BaseView.extend({childId:function(a){return"tab-sprint-"+a.get("id")},isSettingsPage:!1,models:{},events:{"click #add-sprint>a":"createNew"},initialize:function(){this.collection=this.options.collection,this.router=this.options.router,_.bindAll(this,"showNew","getModelFromIteration","restoreTab")},render:function(){var a=this;this.isSettingsPage=$("#backlog-data-area").length==0,this.isSnapshot=$(".not-editable-backlog-notice.snapshot").length>=1?!0:!1;var b=function(b){var c=new App.Views.SprintTabs.Show({model:b,id:a.childId(b),router:a.router});a.$("ul.infinite-tabs").append(c.render().el),a.models[b.get("iteration")]=b},c=[{get:function(){return"Backlog"},active:!0,locked:!0}];return!this.isSettingsPage&&!this.isSnapshot&&c.push({get:function(){return"Stats"},locked:!0}),!this.isSettingsPage&&!this.collection.length&&!this.isSnapshot&&c.push({get:function(){return"Sprints"}}),_(c).each(b),_(this.collection.sortBy(function(a){return-a.get("id")})).each(b),this.isSettingsPage||(this.adjustTabConstraints(),$(this.el).css("top",$("#themes-header").offset().top-$(this.el.find("ul li:first")).outerHeight()+"px")),a.$("ul.infinite-tabs").infiniteTabs(),this},adjustTabConstraints:function(a){var b=this;this.totalTabWidth=$("#backlog-data-area .backlog-stats").offset().left-$(this.el).offset().left,this.windowWidth=$(window).width(),$(this.el).css("width",this.totalTabWidth+"px"),a&&$(this.el).find("ul.infinite-tabs").infiniteTabs("adjust-to-fit"),this.resizeEventAdded||(this.resizeEventAdded=!0,$(window).resize(function(){var a=$(window).width()-b.windowWidth;a&&(b.totalTabWidth+=a,b.windowWidth=$(window).width(),$(b.el).css("width",b.totalTabWidth+"px"))}))},getModelFromIteration:function(a){return this.models[a]},showNew:function(a){this.models[a.get("iteration")]=a;var b=new App.Views.SprintTabs.Show({model:a,id:this.childId(a),router:this.router});this.$("ul.infinite-tabs").infiniteTabs("prepend-tab",b.render().el),this.models.Sprints&&(this.$("ul.infinite-tabs").infiniteTabs("remove-tab",this.$("li#"+this.childId(this.models.Sprints))),delete this.models.Sprints),this.router.navigate(a.get("iteration").toString(),!0)},select:function(a){var b=this.$("ul.infinite-tabs"),c=this.$("li.active");c.length&&b.infiniteTabs("set-tab-content",c,c.find("a").html().replace(/^\s*Sprint (\d+)\s*$/,"$1"));var d=this.$("li#"+this.childId(a));d.parents(".infinite-tabs").find("li").removeClass("active"),d.addClass("active"),b.infiniteTabs("set-tab-content",d,d.find("a").html().replace(/^\s*(\d+)\s*$/,"Sprint $1"))},restoreTab:function(a){var b=this.getModelFromIteration(a);this.select(b)},destroy:function(a,b){var c=this;this.$("ul.infinite-tabs").infiniteTabs("remove-tab",this.$("li#"+this.childId(a))),delete this.models[a.get("iteration")],a.get("iteration")>1?this.models[a.get("iteration")-1].fetch({success:function(a){c.router.navigate(String(a.get("iteration")),!0),_.isFunction(b)&&b()},failure:function(){new App.Views.Error({message:"Internal error, unable to refresh sprint data.  Please refresh your browser"}),c.router.navigate(String(previousModel.get("iteration")),!0),_.isFunction(b)&&b()}}):(this.router.navigate("Backlog",!0),_.isFunction(b)&&b())},createNew:function(a){var b=this,c=this.collection.backlog.get("velocity");a.preventDefault(),$("#dialog-new-sprint").remove(),$("body").append(JST["templates/sprints/new-dialog"]({sprints:this.collection,backlog:this.collection.backlog})),$("#dialog-new-sprint").dialog({resizable:!1,height:c?400:285,width:470,modal:!0,buttons:{Create:function(){var a=$(this),d,e;if(!a.find("form").valid())return $(a).find("p.intro").addClass("error").html("One or more fields are not completed correctly.  Please correct these to continue."),!1;$(this).find("p.progress-placeholder").html("Please wait, creating new sprint..."),$(this).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Preparing..."),$(this).parent().find(".ui-dialog-buttonset button:nth-child(1)").hide(),d={start_on:$.datepicker.formatDate("yy-mm-dd",a.find("#start-on").datepicker("getDate")),duration_days:a.find("#duration-days").val()},!c||a.find("#use-explicit-velocity").is(":checked")?d.explicit_velocity=a.find("#explicit-velocity").val():d.number_team_members=a.find("#number-team-members").val(),e=new Sprint(d),b.collection.length===0&&$.cookie("sprint_duration",e.get("duration_days")),b.collection.add(e),e.save(!1,{success:function(c,d){b.showNew(c),new App.Views.Notice({message:"Sprint number "+c.get("iteration")+" has been added"}),$(a).dialog("close")},error:function(c,d){var e;window.console&&console.log(JSON.stringify(d));if($(a).is(":visible")){try{e=JSON.parse(d.responseText).message,$(a).find("p.intro").addClass("error").html("Oops, we could not create a sprint as it looks like you haven't filled in everything correctly:<br>"+e)}catch(f){$(a).find("p.intro").addClass("error").html("Oops, something has gone wrong and we could not create the sprint.  Please try again."),window.console&&console.log(f)}$(a).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Cancel"),$(a).parent().find(".ui-dialog-buttonset button:nth-child(1)").show(),$(a).find("p.progress-placeholder").html("")}else var g=new App.Views.Error({message:"Sprint was not created, please try again"});b.collection.remove(c)}})},Cancel:function(){$(this).dialog("close")}}});var d=$("#dialog-new-sprint");d.find("#start-on").blur().datepicker(),_.isFunction($.fn.validate)&&d.find("form").validate(App.Views.SharedSprintSettings.formValidationConfig);var e=864e5,f=function(a){var b=new Date(a);switch(b.getDay()){case 0:return a+e;case 6:return a+e*2}return a};if(this.collection.length===0)d.find("#start-on").datepicker("setDate",new Date((new Date).getTime()+864e5)),d.find("#duration-days").val(isNaN(parseInt($.cookie("sprint_duration")))?10:$.cookie("sprint_duration")),d.find("#number-team-members").val("1");else if(this.collection.length==1){var g=this.collection.at(0),h=parseRubyDate(g.get("start_on")).getTime(),i=Number(g.get("duration_days")),j=h+i*e+Math.floor(i/5)*2*e;d.find("#start-on").datepicker("setDate",new Date(f(j))),d.find("#duration-days").val(i),d.find("#number-team-members").val(niceNum(g.get("number_team_members"))),d.find("#explicit-velocity").val(niceNum(g.get("explicit_velocity")))}else{var k=this.collection.sortBy(function(a){return a.get("iteration")}).reverse(),g=k[0],l=k[1],h=parseRubyDate(g.get("start_on")).getTime(),i=Number(g.get("duration_days")),m=parseRubyDate(g.get("start_on")).getTime()-parseRubyDate(l.get("start_on")).getTime(),n=h+i*e+Math.floor(i/5)*2*e,o=h+m,j=Math.max(n,o);d.find("#start-on").datepicker("setDate",new Date(f(j))),d.find("#duration-days").val(g.get("duration_days")),d.find("#number-team-members").val(niceNum(g.get("number_team_members"))),d.find("#explicit-velocity").val(niceNum(g.get("explicit_velocity")))}App.Views.SharedSprintSettings.addFormBehaviour(d,c)}}),Show:App.Views.BaseView.extend({tagName:"li",className:"sprint-tab",events:{"click a":"activate"},initialize:function(){App.Views.BaseView.prototype.initialize.call(this),this.router=this.options.router,this.parentView=this.options.parentView,_.bindAll(this,"remove")},render:function(){return $(this.el).html(JST["templates/sprints/tabs/show"]({model:this.model})),this.model.active&&$(this.el).addClass("active"),this.model.locked&&$(this.el).addClass("locked"),this},activate:function(){this.router.navigate(String(this.model.get("iteration")),!0)}})},App.Views.Sprints={Show:App.Views.BaseView.extend({childId:function(a){return"sprint-story-"+a.get("id")},persistOrderActions:0,events:{"click .stories-divider .change-size":"toggleUnassignedStoriesSize","click a.mark-sprint-as-incomplete":"markSprintAsIncomplete","click a.mark-sprint-as-complete":"markSprintAsComplete","click a.bulk-move-stories":"bulkMoveStories"},initialize:function(a){App.Views.BaseView.prototype.initialize.call(this),this.sprintTabsView=a.sprintTabsView,_.bindAll(this,"persistSprintStories","positionStoriesContainerOnScroll","updateStatistics")},render:function(){var a=this,b={},c;return $(this.el).html(JST["templates/sprints/show"]({model:this.model})),a.toggleUnassignedStoriesSize(!0),this.updateStatistics(this.model.attributes),this.model.fetch({success:function(b){a.updateStatistics(b.attributes)}}),c=function(a){return a.get("position")},_(this.model.SprintStories().sortBy(c)).each(function(b){var c=new App.Views.Sprints.SprintStory({model:b.Story(),parentView:a,id:a.childId(b.Story())});$(a.el).find(".stories-container .cards").append(c.render().el)}),this.model.collection.each(function(a){a.SprintStories().each(function(a){b[a.get("story_id")]=a})}),_(this.model.Backlog().Themes().sortBy(c)).each(function(d){_(d.Stories().sortBy(c)).each(function(c){if(!b[c.get("id")]){var d=new App.Views.Sprints.SprintStory({model:c,parentView:a,id:a.childId(c)});$(a.el).find(".unassigned-stories-container").append(d.render().el)}})}),this.model.IsEditable()||this.$(".unassigned-stories-container .story-card").addClass("locked"),this.$(".stories-container .cards, .unassigned-stories-container").sortable({connectWith:".story-droppable",stop:a.persistSprintStories,placeholder:"story-card-place-holder",cancel:".locked"}).disableSelection(),$(window).bind("scroll.sprints",this.positionStoriesContainerOnScroll).bind("resize.sprints",this.positionStoriesContainerOnScroll),App.Views.MouseTracker||(App.Views.MouseTracker=new MouseTracker(jQuery)),this},updateStatistics:function(a){this.model.set(a),$("#backlog-data-area .backlog-stats").html(JST["templates/sprints/stats"]({attributes:a}));var b=this.$(".stories-container .totals");this.model.SprintStories().length===0?b.addClass("notice").html(JST["templates/sprints/empty"]()):b.removeClass("notice").html(JST["templates/sprints/totals"]({attributes:a,storyCount:this.model.SprintStories().length,sprint:this.model})),this.sprintTabsView.adjustTabConstraints(!0),this.updateSprintButtonsView()},toggleUnassignedStoriesSize:function(a){var b=[70,48.5],c=3,d=1,e=1.5,f=this;a!==!0&&$(this.el).toggleClass("contracted-unassigned-stories"),$(this.el).hasClass("contracted-unassigned-stories")?newStoryContainerSize=b[0]:newStoryContainerSize=b[1],a!==!0?(this.$(".stories-divider .handle").hide(),this.$(".stories-container").animate({width:newStoryContainerSize+"%"},"fast"),this.$(".unassigned-stories-container").animate({width:100-newStoryContainerSize-c+"%","margin-left":newStoryContainerSize+c+"%"},"fast"),this.$(".stories-divider").animate({left:newStoryContainerSize+d+"%"},"fast"),this.$(".unassigned-stories-heading").animate({left:newStoryContainerSize+e+"%",width:99.5-(newStoryContainerSize+e)+"%"},"fast",null,function(){var a=$(f.el).hasClass("contracted-unassigned-stories")?"right":"left";f.$(".stories-divider .handle").show("slide",{direction:a},"fast"),f.$(".story-card").each(function(a,b){$(b).data("reset-toggle")()})})):(this.$(".stories-container").css("width",newStoryContainerSize+"%"),this.$(".unassigned-stories-container").css("width",100-newStoryContainerSize-c+"%").css("margin-left",newStoryContainerSize+c+"%"),this.$(".stories-divider").css("left",newStoryContainerSize+d+"%"),this.$(".unassigned-stories-heading").css("left",newStoryContainerSize+e+"%").css("width",99.5-(newStoryContainerSize+e)+"%"),this.$(".story-card").each(function(a,b){$(b).data("reset-toggle")()}))},persistSprintStories:function(){var a=this,b;b=function(){a.persistOrderActions-=1;if(a.persistOrderActions<=0){a.persistOrderActions=0;var b={};a.$(".stories-container .story-card").each(function(c,d){var e=Number($(d).attr("id").replace("sprint-story-","")),f=a.model.SprintStories().getByStoryId(e);f.get("position")!==c+1&&(b[f.get("id")]=c+1)}),Object.keys(b).length&&a.model.SprintStories().batchUpdatePosition(b,{error:function(){var a=new App.Views.Error({message:"Order of stories could not be saved.  Please refresh your browser"})}})}},this.model.SprintStories().each(function(c){if(!a.$(".stories-container #"+a.childId(c.Story())).length){var d=$(".unassigned-stories-container #"+a.childId(c.Story()));d.data("reset-toggle")(),c.beingDestroyed||(a.persistOrderActions+=1,c.beingDestroyed=!0,c.destroy({success:function(e,f){c.beingDestroyed=!1,a.updateStatistics(f.sprint_statistics),a.model.set(f.sprint_statistics),b(),d.data("update-sprint-story-status")()},error:function(a,b){c.beingDestroyed=!1;var d="Oops, we've been unable to remove that story from this sprint.  Please refresh your browser.";try{d=$.parseJSON(b.responseText).message}catch(e){window.console&&console.log(e)}var f=new App.Views.Error({message:d})}}))}}),this.$(".stories-container .story-card").each(function(c,d){var e=Number($(d).attr("id").replace("sprint-story-",""));if(!a.model.SprintStories().getByStoryId(e)){$(d).data("reset-toggle")();var f=new SprintStory({story_id:$(d).data("story_id"),sprint_id:a.model.get("id")});a.model.SprintStories().add(f),a.persistOrderActions+=1,f.save(!1,{success:function(c,e){a.updateStatistics(c.get("sprint_statistics")),a.model.set(c.get("sprint_statistics")),b(),$(d).data("update-sprint-story-status")()},error:function(a,b){var c="we've got a problem on our side";try{c=$.parseJSON(b.responseText).message}catch(d){window.console&&console.log(d)}var e=new App.Views.Error({message:"Oops, "+c+".  Please refresh your browser"})}})}}),a.persistOrderActions===0&&b(),this.positionStoriesContainerOnScroll(),$(".story-card").each(function(a,b){App.Views.MouseTracker.isOver(b)&&$(b).trigger("mouseenter")})},positionStoriesContainerOnScroll:function(){var a=this.$(".stories-container"),b=this.$(".unassigned-stories-container"),c=this.$(".stories-divider"),d=a.outerHeight(),e=$(window).height(),f=$(window).scrollTop(),g=Math.max(d-e/2+$(".main-content-pod").offset().top,$(".main-content-pod").offset().top);this.storiesContainerTop||(this.storiesContainerTop=a.offset().top);var h=b.offset().left-c.width()-a.offset().left+(c.offset().left+c.width()-b.offset().left)*2;f>g&&a.height()<b.height()?(a.css("position")!=="fixed"&&a.css("position","fixed").css("top",Math.floor(this.storiesContainerTop-g)+"px").css("width",h+"px"),a.css("top")!==Math.floor(this.storiesContainerTop-g)+"px"&&a.animate({top:Math.floor(this.storiesContainerTop-g)+"px"},"fast")):a.css("position")!=="static"&&a.css("position","static").css("top","auto"),a.css("width")!==h+"px"&&a.css("width",h+"px")},cleanUp:function(){$(window).unbind(".sprints")},markSprintAsComplete:function(a){var b=this;a.preventDefault();var c=this.model.SprintStories().reject(function(a){return a.Status().IsDone()}),d=_(this.model.Backlog().Sprints().select(function(a){return a.get("iteration")<b.model.get("iteration")&&!a.IsComplete()})).sortBy(function(a){return a.get("iteration")});c.length?new App.Views.Warning({message:"All stories must be marked as Done before marking this sprint as complete"}):d.length?new App.Views.Warning({message:"Sprint "+_(d).last().get("iteration")+" is not complete. Please mark as complete first"}):(this.model.set({completed:"true"}),this.updatedSprintCompletedStatus())},markSprintAsIncomplete:function(a){var b=this;a.preventDefault();var c=_(this.model.Backlog().Sprints().select(function(a){return a.get("iteration")>b.model.get("iteration")&&a.IsComplete()})).sortBy(function(a){return a.get("iteration")});c.length?new App.Views.Warning({message:"Sprint "+_(c).first().get("iteration")+" is complete. Please mark as incomplete first"}):(this.model.set({completed:"false"}),this.updatedSprintCompletedStatus())},updatedSprintCompletedStatus:function(){var a=this;this.model.save(!1,{success:function(b,c){a.updateSprintButtonsView(),new App.Views.Notice({message:"Sprint status updated"})},error:function(a,b){var c="Oops, we've been unable to update the sprint, please try again";try{c=$.parseJSON(b.responseText).message}catch(d){window.console&&console.log(d)}var e=new App.Views.Error({message:c})}})},updateSprintButtonsView:function(){var a=this,b=$("<div>"+JST["templates/sprints/show"]({model:a.model})+"</div>");a.$("h2").replaceWith(b.find("h2")),a.$(".complete-status").replaceWith(b.find(".complete-status")),a.$(".unassigned-stories-container .notice").remove(),a.model.IsEditable()?a.$(".unassigned-stories-container .story-card").removeClass("locked"):(a.$(".unassigned-stories-container").prepend(b.find(".unassigned-stories-container .notice")),a.$(".unassigned-stories-container .story-card").addClass("locked"))},bulkMoveStories:function(a){var b=this,c=this.model.Backlog().Sprints().filter(function(a){return a.get("iteration")>b.model.get("iteration")});a.preventDefault(),$("#dialog-move-sprint-stories").remove(),$("body").append(JST["templates/sprints/move-dialog"]({sprints:c})),$("#dialog-move-sprint-stories").dialog({resizable:!1,height:200,width:280,modal:!0,buttons:{Move:function(){var a=$(this).find("select").val(),c=b.model.SprintStories().incompleteStories();a===""?$(this).find("div.error-message").html("<p>You must select a destination first.</p>"):($(this).find(".progress-placeholder").html("<p>Please wait while we move the incomplete stories...</p>"),$(this).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Preparing..."),$(this).parent().find(".ui-dialog-buttonset button:nth-child(1)").hide(),_(c).each(function(c){var d=c.Story(),e=b.$("#"+b.childId(d));a==="backlog"?e.data("move-story")():(e.slideUp(),c.save({move_to_sprint_id:a},{success:function(c,d){b.model.SprintStories().remove(c),b.model.collection.get(a).SprintStories().add(c)},error:function(a,b){var c="There was an error moving the stories...  Please refresh your browser.";try{c=$.parseJSON(b.responseText).message}catch(d){window.console&&console.log(d)}var e=new App.Views.Error({message:c})}}))}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}}})}}),Help:App.Views.BaseView.extend({pod:!1,initialize:function(a){App.Views.BaseView.prototype.initialize.call(this),this.sprintTabsView=a.sprintTabsView,_.bindAll(this,"addSprint")},render:function(){$(this.el).html(JST["templates/sprints/help"]({backlog:this
.model})),this.pod=$(JST["templates/sprints/help-pod"]({backlog:this.model})),this.pod.find("a.add-new-sprint").click(this.addSprint),this.$("a.add-new-sprint").click(this.addSprint),$("section.main-content-pod").before(this.pod),$("#backlog-data-area .backlog-stats").html("")},addSprint:function(a){this.sprintTabsView.createNew(a)},cleanUp:function(){this.pod.remove()}}),SprintStory:App.Views.BaseView.extend({tagName:"div",className:"story-card",contractedHeight:90,heightBuffer:10,events:{"click .more .tab":"toggleMore","click .move":"moveStory","click .status .tab":"statusChangeClick"},initialize:function(a){App.Views.BaseView.prototype.initialize.call(this),this.parentView=a.parentView,_.bindAll(this,"resetToggle","updateSprintStoryStatus")},render:function(){var a=this;return $(this.el).html(JST["templates/sprints/sprint-story"]({model:this.model})),this.setStatusHover(),setTimeout(function(){a.resetToggle()},1),$(this.el).data("reset-toggle",this.resetToggle),$(this.el).data("move-story",function(){a.moveStory()}),$(this.el).hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")}),$(this.el).data("story_id",this.model.get("id")),$(this.el).data("update-sprint-story-status",this.updateSprintStoryStatus),this.model.get("color")&&App.Views.Helpers.setStoryColor(this.el,this.model.get("color")),this.setEditableState(),this},resetToggle:function(){$(this.el).css("height","auto"),$(this.el).height()>this.contractedHeight+this.heightBuffer?($(this.el).data("original-height",$(this.el).height()),this.toggleMore(0)):$(this.el).find(".more").css("display","none")},updateSprintStoryStatus:function(){$(this.el).find(".status").html($(JST["templates/sprints/sprint-story"]({model:this.model})).find(".status")),this.setStatusHover(),this.setEditableState()},setStatusHover:function(){App.Views.Helpers.setStatusHover.apply(this,arguments)},statusChangeClick:function(){App.Views.Helpers.statusChangeClick.apply(this,arguments)},setEditableState:function(){this.model.IsEditable()?$(this.el).removeClass("locked"):$(this.el).addClass("locked")},toggleMore:function(a){var b=isNaN(parseInt(a))?"fast":a,c=this;$(this.el).find(".more").css("display","block"),$(this.el).css("height")===this.contractedHeight+"px"?($(this.el).animate({height:$(this.el).data("original-height")},b,null,c.parentView.positionStoriesContainerOnScroll),$(this.el).find(".more").addClass("less").find(".tab").text("less")):($(this.el).animate({height:this.contractedHeight+"px"},b,null,c.parentView.positionStoriesContainerOnScroll),$(this.el).find(".more").removeClass("less").find(".tab").text("more"))},moveStory:function(){$(this.el).removeClass("hover"),$(this.el).parents(".stories-container .cards").length==0?this.parentView.$(".stories-container .cards").append(this.el):this.parentView.$(".unassigned-stories-container").prepend(this.el),this.parentView.persistSprintStories()}})},App.Views.Stories={Index:Backbone.View.extend({tagName:"ul",className:"stories",childId:function(a){return"story-"+a.get("id")},events:{"click .actions a.new-story":"createNew","keydown .actions a.new-story":"addStoryKeyPress"},initialize:function(){this.collection=this.options.collection,_.bindAll(this,"orderChanged")},render:function(){var a=this;this.collection.each(function(b){var c=new App.Views.Stories.Show(App.Views.Helpers.addUseOptions({model:b,id:a.childId(b)},a.options));$(a.el).append(c.render().el)});if(this.collection.theme.IsEditable()){this.collection.theme.isNew()||$(this.el).append(JST["templates/stories/new"]());var b=this.orderChanged,c;$(this.el).sortable({start:function(b,d){c=a.$(">.actions").clone(),a.$(">.actions").remove(),a.storyDragged=!0,$("#vtip").remove(),a.$(".move-story.vtipActive").mouseleave(),a.$(".move-story").removeClass("vtip"),$(".color-picker").hide()},stop:function(d,e){App.Views.Stories.Index.stopMoveEvent=!0,b(),$(a.el).append(c),a.$(".move-story").addClass("vtip")},placeholder:"target-order-highlight",axis:"y",items:"li.story"}).find(".move-story").disableSelection(),this.$(".color-picker-icon a").click(function(a){$("#vtip").remove(),$(a.target).mouseleave()})}return this},createNew:function(a){a.preventDefault();var b=new Story;this.collection.add(b),this.$("li:last").before((new App.Views.Stories.Show(App.Views.Helpers.addUseOptions({model:b},this.options))).render().el);var c=this;this.$("li.story:last").css("display","none").slideDown("fast",function(){c.$("li.story:last > .user-story > .as-a > .data").click()})},addStoryKeyPress:function(a){var b,c,d;9==a.keyCode?(a.preventDefault(),a.shiftKey?(a.preventDefault(),b=$(this.el).parents("li.theme"),d=b.find("li.story:not(.locked):last .score-90 .data, li.story:not(.locked):last .score .data"),d.length?App.Views.Helpers.scrollIntoBacklogView(d,function(){d.click()}):App.Views.Helpers.scrollIntoBacklogView(b.find(".theme-data .name .data"),function(a){a.click()})):(c=$(this.el).parents("li.theme").next(),c.hasClass("theme")?App.Views.Helpers.scrollIntoBacklogView(c.find(".theme-data .name .data"),function(a){a.click()}):App.Views.Helpers.scrollIntoBacklogView(c.find("a.new-theme"),function(a){a.focus()}))):13===a.keyCode&&(a.preventDefault(),this.createNew(a))},orderChanged:function(){var a={};this.$("li.story").each(function(b,c){var d=_.last($(c).attr("id").split("-"));isNaN(parseInt(d,10))||(a[d]=b+1)}),window.console&&console.log("Order changed and saving - "+JSON.stringify(a)),this.collection.saveOrder(a)}}),Show:App.Views.BaseView.extend({tagName:"li",className:"story",deleteDialogTemplate:"templates/stories/delete-dialog",events:{"click .delete-story>a":"remove","click .duplicate-story>a":"duplicate","click .status .tab":"statusChangeClick"},initialize:function(){var a=this;App.Views.BaseView.prototype.initialize.call(this),_.bindAll(this,"navigateEvent","moveToThemeDialog","moveToTheme","changeColor","updateViewWithModelData"),this.model.bind("change",function(b){a.updateViewWithModelData(b.changedAttributes())})},render:function(){return this.updateViewWithModelData("all"),this.configureView(),this},configureView:function(){var a=new App.Views.AcceptanceCriteria.Index({collection:this.model.AcceptanceCriteria()}),b=this,c=[".user-story .data",".unique-id .data",".comments .data",".score-50 .data",".score-90 .data",".score .data"];this.$(".acceptance-criteria").html(a.render().el),this.model.IsEditable()?(this.makeFieldsEditable(),this.$(".move-story a").mousedown(function(a){App.Views.Stories.Index.stopMoveEvent=!1}).click(function(a){a.preventDefault(),App.Views.Stories.Index.stopMoveEvent||b.moveToThemeDialog()}),this.$(".color-picker-icon a").simpleColorPicker({onChangeColor:function(a){b.changeColor(a)},colorsPerLine:4,colors:["#ffffff","#dddddd","#bbbbbb","#999999","#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#6666ff","#9900ff","#ff00ff","#f4cccc","#d9ead3","#cfe2f3","#ead1dc","#ffe599","#b6d7a8","#b4a7d6","#d5a6bd","#e06666","#f6b26b","#ffd966","#93c47d"]})):this.model.IsLocked()||_.each(c,function(a){b.$(a).click(function(){var a=b.model.CanEdit()?"You cannot edit a story that is marked as done":"You do not have permission to edit stories for this backlog";new App.Views.Warning({message:a})})}),this.model.get("color")&&this.changeColor(this.model.get("color"),{silent:!0}),App.Views.Helpers.activateUrlify(this.el),this.setStatusHover()},updateViewWithModelData:function(a){var b=this;a==="all"?$(this.el).html(JST["templates/stories/show"](App.Views.Helpers.addUseOptions({model:this.model},this.options))):a&&(a.sprint_story_status_id||a.sprint_story_id)&&($(this.el).html(JST["templates/stories/show"](App.Views.Helpers.addUseOptions({model:this.model},this.options))),this.configureView()),this.model.IsEditable()?$(this.el).removeClass("locked"):$(this.el).addClass("locked")},setStatusHover:function(){App.Views.Helpers.setStatusHover.apply(this,arguments)},statusChangeClick:function(a){App.Views.Helpers.statusChangeClick.apply(this,arguments)},makeFieldsEditable:function(){var a=this,b=function(b){return a.contentUpdated(b,this)},c=function(b){return a.beforeChange(b,this)},d=_.extend(_.clone(this.defaultEditableOptions),{data:c,onKeyDown:a.navigateEvent}),e=function(c){return a.model.Theme().get("code")+b.call(this,c)},f=function(a){return c.call(this,a.substring(3))},g=function(a){return b.call(this,niceNum(a))},h=function(a){var c=this;return setTimeout(function(){$(c).html(urlify($(c).html(),35))},100),b.call(this,a)},i=function(a){return unUrlify(this),c.call(this,$(this).text())},j=_.extend(_.clone(d),{data:f,maxLength:4});this.$(">div.unique-id .data").editable(e,j),this.$(">div.score-50 .data, >div.score-90 .data, >div.score .data").editable(g,_.extend(_.clone(d),{maxLength:4})),this.$(">div.comments .data").editable(h,_.extend(_.clone(d),{type:"textarea",saveonenterkeypress:!0,autoResize:!0,data:i,noChange:h}));var k=function(){var b=[];return a.model.Theme().collection.each(function(a){b=b.concat(a.Stories().pluck("as_a"))}),_.uniq(_.compact(b)).sort()};_.each(["as-a","i-want-to","so-i-can"],function(c){_.defer(function(){var e=a.$(">div.user-story ."+c+" .heading").outerWidth()+10,f=_.extend(_.clone(d),{type:c=="as-a"?"text":"textarea",maxLength:c=="as-a"?100:2040,saveonenterkeypress:!0,lesswidth:e,autoResize:!0,autoComplete:k});a.$(">div.user-story ."+c+" .data").editable(b,f)})})},navigateEvent:function(a){var b=$(a.target).is("input"),c,d,e,f,g,h,i;if(_.include([9,13,27],a.keyCode)&&(b||!a.ctrlKey)){$(a.target).blur();try{a.preventDefault()}catch(j){}c=["unique-id .data","as-a .data","i-want-to .data","so-i-can .data","acceptance-criteria ul.acceptance-criteria li:first-child>*","comments .data"],this.options.use5090Estimates?(c.push("score-50 .data"),c.push("score-90 .data")):c.push("score .data"),d=$(a.target),d.hasClass("data")||(d=d.parents(".data:first")),d=d.parent(),e=_.detect(c,function(a){return d.hasClass(_.first(a.split(" ")))});if(e)if(!a.shiftKey)if(e!=_.last(c))this.$("."+c[_.indexOf(c,e)+1]).click();else{var f=$(this.el).nextAll("li:not(.locked):first");f.find("a.new-story").length?App.Views.Helpers.scrollIntoBacklogView(f.find("a.new-story"),function(a){a.focus()}):App.Views.Helpers.scrollIntoBacklogView(f.find("."+_.first(c)),function(a){a.click()})}else if(e!=_.first(c)){var g=c[_.indexOf(c,e)-1];if(g.indexOf("acceptance-criteria")===0){var h=this.$(".acceptance-criteria ul.acceptance-criteria li:visible:last>*");App.Views.Helpers.scrollIntoBacklogView(h,function(a){a.click()})}else this.$("."+g).click()}else i=$(this.el).prevAll("li:not(.locked):first"),i.length?App.Views.Helpers.scrollIntoBacklogView(i.find(".score-90 .data, .score .data"),function(a){a.click()}):App.Views.Helpers.scrollIntoBacklogView($(this.el).parents("li.theme").find(".theme-data >.name .data"),function(a){a.click()})}},changeEvent:function(a,b){var c;if(a.substring(0,7)==="change:"&&a!=="change:acceptance_criteria"){var d=a.substring(7);c=this.model.get(d),d==="unique_id"?this.$(">div."+d.replace(/_/gi,"-")+">div.data input").length===0?(c=this.model.Theme().get("code")+c,this.$(">div."+d.replace(/_/gi,"-")+">div.data").text(c)):this.$(">div."+d.replace(/_/gi,"-")+">div.data input").val(c):_.isString(c)&&(d.match(/^score/)?c=niceNum(c):c=multiLineHtmlEncode(c),c===""&&(c=this.defaultEditableOptions.placeholder),this.$("div."+d.replace(/_/gi,"-")+">div.data").html(c)),a=="change:id"&&$(this.el).attr("id","story-"+b.get("id")),App.Controllers.Statistics.updateStatistics(this.model.get("score_statistics"))}},deleteAction:function(a,b){var c=b.model.collection;$(a).find(">p").html("Deleting story...<br /><br />Please wait."),$(a).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Close"),$(a).parent().find(".ui-dialog-buttonset button:nth-child(1)").remove(),b.model.destroy({error:function(b,c){var d="Unable to delete story...";try{d=$.parseJSON(c.responseText).message}catch(e){window.console&&console.log(e)}var f=new App.Views.Error({message:d});$(a).dialog("close")},success:function(d,e){c.remove(b.model),$(b.el).remove(),$(a).dialog("close"),App.Controllers.Statistics.updateStatistics(e.score_statistics)}})},moveToThemeDialog:function(){window.console&&console.log("Requested to move");var a=this;$("#dialog-move-story").remove(),$("body").append(JST["templates/stories/move-dialog"]({story:this.model,themes:this.model.Theme().Backlog().Themes()})),$("#dialog-move-story").dialog({resizable:!1,height:170,modal:!0,buttons:{Move:function(){a.moveToTheme(this)},Cancel:function(){$(this).dialog("close")}}})},moveToTheme:function(a){var b=$(a).find("select#theme-target option:selected").attr("id");b!=this.model.Theme().get("id")&&(window.console&&console.log("Moving to theme-"+b),$(this.el).insertBefore($("li.theme#theme-"+b+" ul.stories>li:last")),this.model.MoveToTheme(b,{success:function(a,b){var c=new App.Views.Notice({message:"The story was moved successfully."})},error:function(){var a=new App.Views.Error({message:"The story move failed.  Please refresh your browser."})}})),$(a).dialog("close")},changeColor:function(a,b){var c=App.Views.Helpers.setStoryColor(this.el,a);if(!b||!b.silent)this.model.set({color:c}),this.model.save()},duplicate:function(a){var b=new Story,c=_.clone(this.model.attributes);a.preventDefault(),delete c.id,delete c.unique_id,this.model.AcceptanceCriteria().each(function(a){var c=new AcceptanceCriterion;c.set({criterion:a.get("criterion")}),b.AcceptanceCriteria().add(c)}),b.set(c),this.model.collection.add(b);var d=new App.Views.Stories.Show(App.Views.Helpers.addUseOptions({model:b,id:0},this.options)),e=$(d.render().el);e.insertBefore($(this.el).parents("ul.stories").find(">li.actions")),b.save(!1,{success:function(a,b){a.AcceptanceCriteria().each(function(a){a.save()})},error:function(a,b){window.console&&console.log(JSON.stringify(b));var c=new App.Views.Error({message:"The story could not be copied.  Please refresh your browser."})}}),_.delay(function(){e.find(".user-story .as-a>.data").click()},400)}})},App.Views.Themes={Index:Backbone.View.extend({tagName:"div",className:"themes",reorderSlideUpElements:"ul.stories,.theme-stats,ul.themes .theme-actions,ul.themes .theme-data .code,ul.themes>li.actions",childId:function(a){return"theme-"+a.get("id")},events:{"click ul.themes .actions a.new-theme":"createNew","keydown ul.themes .actions a.new-theme":"themeKeyPress","click ul.themes .actions a.reorder-themes":"startReorder","keydown ul.themes .actions a.reorder-themes":"themeKeyPress","click .stop-ordering a":"stopReorder"},initialize:function(){this.collection=this.options.collection,_.bindAll(this,"orderChanged")},render:function(){var a=this;$(this.el).html(JST["templates/themes/index"]({collection:this.collection.models})),this.collection.each(function(b){var c=new App.Views.Themes.Show(App.Views.Helpers.addUseOptions({model:b,id:a.childId(b)},a.options));a.$(">ul").append(c.render().el)}),this.$("ul.themes").append(JST["templates/themes/new"]());if(this.collection.backlog.IsEditable()){var b=this.orderChanged,c,d;this.$("ul.themes").sortable({start:function(a,b){},stop:function(a,c){b()},placeholder:"target-order-highlight",axis:"y",handle:".move-theme"}).find(".move-theme").disableSelection()}else this.$("ul.themes>li.actions").remove();return this},startReorder:function(a){a.preventDefault();if($("ul.themes li.theme").length<2)var b=new App.Views.Warning({message:"You need more than one theme to reorder"});else{var c=this;this.$(this.reorderSlideUpElements).slideUp(250,function(){c.$(".move-theme").css("display","block"),c.$(".stop-ordering").css("display","block")})}},stopReorder:function(a){a.preventDefault(),this.$(".move-theme").css("display","none"),this.$(".stop-ordering").css("display","none"),this.$(this.reorderSlideUpElements).slideDown(250)},createNew:function(a){a.preventDefault();var b=new Theme;this.collection.add(b),this.$("ul.themes li:last").before((new App.Views.Themes.Show(App.Views.Helpers.addUseOptions({model:b},this.options))).render().el);var c=this;this.$("ul.themes li.theme:last").css("display","none").slideDown("fast",function(){$(c.el).find("ul.themes li.theme:last>.theme-data .name .data").click()})},themeKeyPress:function(a){var b=$(a.target);if(9==a.keyCode){a.preventDefault();if(!a.shiftKey)b.is("a.new-theme")?this.$("a.reorder-themes").focus():b.is("a.reorder-themes")&&$("#backlog-data-area h2.name .data").click();else if(b.is("a.new-theme")){if(this.$("li.theme").length>0){var c=$("li.theme:last");c.has("li.actions a.new-story").length?c.find("li.actions a.new-story").focus():c.find(".theme-data .name .data").click()}}else b.is("a.reorder-themes")&&this.$("a.new-theme").focus()}else 13==a.keyCode&&(b.is("a.new-theme")?this.createNew(a):b.is("a.reorder-themes")&&this.startReorder(a))},orderChanged:function(){var a={};this.$("li.theme").each(function(b,c){var d=_.last($(c).attr("id").split("-"));isNaN(parseInt(d,10))||(a[d]=b+1)}),window.console&&console.log("Order changed and saving - "+JSON.stringify(a)),this.collection.saveOrder(a)}}),Show:App.Views.BaseView.extend({tagName:"li",className:"theme",deleteDialogTemplate:"templates/themes/delete-dialog",events:{"click .delete-theme>a":"remove","click .re-number-stories a":"reNumberStories"},initialize:function(){App.Views.BaseView.prototype.initialize.call(this),_.bindAll(this,"navigateEvent","reNumberStoriesAction")},render:function(){var a,b=this;return $(this.el).html(JST["templates/themes/show"]({model:this.model})),a=new App.Views.Stories.Index(App.Views.Helpers.addUseOptions({collection:this.model.Stories()},this.options)),this.$(">.stories").prepend(a.render().el),this.updateStatistics(),this.model.IsEditable()?this.makeFieldsEditable():(this.$("ul.stories>li.actions").remove(),this.$(".re-number-stories a").remove(),this.$(".delete-theme>a").remove(),this.model.IsLocked()||_.each([".theme-data .name div.data",".theme-data .code div.data"],function(a){b.$(a).click(function(){new App.Views.Warning({message:"You do not have permission to edit themes for this backlog"})})})),this},makeFieldsEditable:function(){var a=this,b=function(b,c){var d=a.contentUpdated(b,c,this),e=$(this).parent().attr("class").replace(/\-/g,"_");return e=="code"&&a.model.Stories().each(function(a,b){a.trigger("change:unique_id")}),d},c=function(b,c){return a.beforeChange(b,c,this)},d=_.extend(_.clone(this.defaultEditableOptions),{data:c,onKeyDown:a.navigateEvent});this.$(".theme-data .name div.data").editable(b,_.extend(_.clone(d),{maxLength:100})),this.$(".theme-data .code div.data").editable(b,_.extend(_.clone(d),{widen:8,maxLength:3}))},navigateEvent:function(a){var b,c,d,e,f;if(_.include([9,13,27],a.keyCode)){try{a.preventDefault()}catch(g){}a.shiftKey?(e=$(a.target).parents(".data"),e.parent().hasClass("name")?(f=$(this.el).prev(),f.length?(d=f.find("ul.stories li.actions a.new-story"),d.length?($(a.target).blur(),App.Views.Helpers.scrollIntoBacklogView(d,function(a){a.focus()})):($(a.target).blur(),App.Views.Helpers.scrollIntoBacklogView(f.find(".theme-data >.name .data"),function(a){a.click()}))):_.delay(function(){e.click()},200)):($(a.target).blur(),this.$(".theme-data >.name .data").click())):($(a.target).blur(),b=$(this.el).find("li.story:not(.locked):first"),b.length?App.Views.Helpers.scrollIntoBacklogView(b.find(".unique-id .data"),function(a){a.click()}):($(this.el).next().find("a.new-theme").focus(),c=$(this.el).find("ul.stories li a.new-story"),c.length?App.Views.Helpers.scrollIntoBacklogView(c,function(a){a.focus()}):App.Views.Helpers.scrollIntoBacklogView($(this.el).next().find(".theme-data > .name .data"),function(a){a.click()})))}},changeEvent:function(a,b){if(a.substring(0,7)=="change:"){var c=a.substring(7);this.$(">.theme-data>."+c.replace(/_/gi,"-")+">div.data").text(this.model.get(c)),this.updateStatistics(),App.Controllers.Statistics.updateStatistics(this.model.get("score_statistics"))}a=="change:id"&&($(this.el).attr("id","theme-"+b.get("id")),this.$("ul.stories li.actions .new-story").length||this.model.isNew()||this.$(".stories ul.stories").append(JST["templates/stories/new"]()).find(".actions a").focus())},deleteAction:function(a,b){var c=b.model.collection;$(a).find(">p").html("Deleting theme...<br /><br />Please wait."),$(a).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Close"),$(a).parent().find(".ui-dialog-buttonset button:nth-child(1)").remove(),b.model.destroy({error:function(b,c){var d="Unable to delete story...";try{d=$.parseJSON(c.responseText).message}catch(e){window.console&&console.log(e)}var f=new App.Views.Error({message:d});$(a).dialog("close")},success:function(d,e){c.remove(b.model),$(b.el).remove(),$(a).dialog("close"),App.Controllers.Statistics.updateStatistics(e.score_statistics)}})},updateStatistics:function(){this.$(".theme-stats div").html(JST["templates/themes/stats"](App.Views.Helpers.addUseOptions({model:this.model},this.options)))},reNumberStories:function(a){var b=this;a.preventDefault(),$("#dialog-re-number").remove(),$("body").append(JST["templates/themes/re-number-dialog"]({})),$("#dialog-re-number").dialog({resizable:!1,height:170,modal:!0,buttons:{"Re-number":function(){b.reNumberStoriesAction(this)},Cancel:function(){$(this).dialog("close")}}})},reNumberStoriesAction:function(a){var b=this;$(a).find(">p").html('Re-numbering stories...<br />Please wait.<br /><br /><span class="progress-icon"></span>'),$(a).parent().find(".ui-dialog-buttonset button:nth-child(2) span").text("Close"),$(a).parent().find(".ui-dialog-buttonset button:nth-child(1)").remove(),b.model.ReNumberStories({success:function(){$(a).dialog("close")},error:function(b){var c="Server error trying to renumber stories";try{c=$.parseJSON(b.responseText).message;var d=new App.Views.Warning({message:c})}catch(e){window.console&&console.log(e);var d=new App.Views.Error({message:c})}$(a).dialog("close")}})}})},App.Routers.Backlog=Backbone.Router.extend({backlogView:!1,oldView:!1,routes:{"":"showBacklog",Backlog:"showBacklog",Stats:"showStats",Sprints:"showSprintsHelp",":iteration":"showSprint"},initialize:function(a){_.bindAll(this,"setTabsReference","cleanUpOldView")},setTabsReference:function(a){this.sprintTabsView=a},showBacklog:function(){this.cleanUpOldView(),this.backlogView?(this.backlogView.activated(),this.showContainer("#backlog-container")):(this.backlogView=new App.Views.Backlogs.Show({model:App.Collections.Backlogs.at(0),el:$("#backlog-container"),sprintTabsView:this.sprintTabsView}),this.backlogView.render(),this.showContainer("#backlog-container")),this.sprintTabsView.select(this.sprintTabsView.getModelFromIteration("Backlog"))},showStats:function(){this.cleanUpOldView(),this.statsView?(this.statsView.activated(),this.showContainer("#stats-container")):(this.statsView=new App.Views.BacklogStats.Show({model:App.Collections.Backlogs.at(0),el:this.replaceWithNew("#stats-container")}),this.statsView.render(),this.showContainer("#stats-container")),this.sprintTabsView.select(this.sprintTabsView.getModelFromIteration("Stats"))},showSprintsHelp:function(){this.cleanUpOldView(),this.oldView=new App.Views.Sprints.Help({model:App.Collections.Backlogs.at(0),sprintTabsView:this.sprintTabsView,el:this.replaceWithNew("#sprints-help-container")}),this.showContainer("#sprints-help-container"),this.oldView.render(),this.sprintTabsView.select(this.sprintTabsView.getModelFromIteration("Sprints"))},showSprint:function(a){var b=this.sprintTabsView.getModelFromIteration(a);this.cleanUpOldView();if(!b){var c=new App.Views.Warning({message:"Sprint "+a+" was not found"});this.navigate("Backlog",!0)}else this.oldView=new App.Views.Sprints.Show({model:b,el:this.replaceWithNew("#sprints-container"),sprintTabsView:this.sprintTabsView}),this.showContainer("#sprints-container"),this.oldView.render(),this.sprintTabsView.select(b)},replaceWithNew:function(a){var b=$(a).empty(),c=b[0].outerHTML||(new XMLSerializer).serializeToString(b[0]);return $(a).replaceWith($(c)),$(a)},showContainer:function(a){containers=["#sprints-container","#sprints-help-container","#stats-container","#backlog-container"],_(containers).each(function(a){$("section.main-content-pod").removeClass("showing-"+a.replace(/#|\-container/gi,""))}),$("section.main-content-pod").addClass("showing-"+a.replace(/#|\-container/gi,""))},cleanUpOldView:function(){this.oldView&&(_.isFunction(this.oldView.cleanUp)&&this.oldView.cleanUp(),this.oldView=!1)}}),function(){this.JST||(this.JST={}),this.JST["templates/_shared/backlog_stats"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{}){__p.push("");var pointsText=addCommas((model.get("points")||0).toFixed(1))+" "+(model.get("points")==1?I18n.t("point"):I18n.t("points"));__p.push("\n"),useDaysEstimates?__p.push("\n  ",pointsText,"\n"):__p.push("\n  <strong>",pointsText,"</strong>\n"),__p.push("\n"),useCostEstimates&&__p.push("\n  / ",model.get("cost_formatted"),"\n"),__p.push("\n"),useDaysEstimates&&__p.push("\n  / <strong>",addCommas((model.get("days")||0).toFixed(1))," ",model.get("days")==1?I18n.t("day"):I18n.t("days"),"</strong>\n"),__p.push("\n")}return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/acceptance_criteria/index"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<ul class="acceptance-criteria"></ul>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/acceptance_criteria/new"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<li class="actions new-acceptance-criterion">\n  <div><span class="editable-blank">[edit]</span></div>\n</li>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/acceptance_criteria/show"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="index'),model.IsEditable()&&__p.push(" cross-hair-enabled"),__p.push('" title="Drag to reorder">&nbsp;</div>\n<div class="cross-hair-indicator'),model.IsEditable()&&__p.push(" cross-hair-enabled"),__p.push('">&nbsp;</div>\n<div class="data">',urlify(multiLineHtmlEncode(model.get("criterion")),35),"</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/backlogs/compare-snapshot-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-compare-snapshot" title="Compare snapshots">\n  <form>\n    <p>\n      <span class="ui-icon ui-icon-transferthick-e-w" style="float:left; margin:0 7px 30px 0;" />\n      Please choose which snapshots you wish to compare, and a new window will be opened showing you the comparison.\n    </p>\n    <div class="error-message"></div>\n    <div class="elements">\n      <p>\n        <label for="base-snapshot">Which snapshot is your base (typically the older version)?</label>\n      </p>\n      <p>\n        <select id="base-snapshot">\n          ',snapshot_options,'\n        </select>\n      </p>\n      <br />\n      <p>\n        <label for="target-snapshot">Which snapshot are you comparing against (typically the newer version)?</label>\n      </p>\n      <p>\n        <select id="target-snapshot">\n          ',snapshot_options,"\n        </select>\n      </p>\n    </div>\n  </form>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/backlogs/create-snapshot-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-create-snapshot" title="Create new snapshot">\n  <form>\n    <p>\n      <span class="ui-icon ui-icon-plusthick" style="float:left; margin:0 7px 30px 0;" />\n      Creating a snapshot of the current working version of the backlog saves an exact replica of the backlog now for later reference.\n    </p>\n    <div class="progress-area">\n      <p>\n        <label for="snapshot-name">Please name your snapshot:</label>\n      </p>\n      <p>\n        <input id="snapshot-name" type="text" value="">\n      </p>\n    </div>\n  </form>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/backlogs/presence"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="header">\n  <div class="icon">\n    <span class="ui-icon ui-icon-alert"></span>\n  </div>\n  <div class="title">\n    ',people.length," other "),people.length===1?__p.push("person is"):__p.push("people are"),__p.push(' simultaneously editing this backlog\n  </div>\n</div>\n<div class="people">\n  The following '),people.length===1?__p.push("person is"):__p.push("people are"),__p.push(" currently editing this backlog:\n  <ul>\n    "),_(people).each(function(a){__p.push("\n      <li>",htmlEncode(a),"</li>\n    ")}),__p.push("\n  </ul>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/backlogs/print-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{}){__p.push('<div id="dialog-print" title="Print story cards">\n  <form>\n    <p>\n      <span class="ui-icon ui-icon-print" style="float:left; margin:0 7px 30px 0;" />\n      Printing story cards requires the use of a printer that is capable of duplexing (double-sided printing).  Alternatively, and less favourably, you can glue each page pair together.\n    </p>\n    <p>\n      What would you like to print?\n    </p>\n    <p>\n      <select id="print-scope">\n        <option id="">All themes</option>\n        <optgroup label="Only the following theme">\n        '),backlog.Themes().each(function(a){__p.push('\n          <option id="theme-',a.get("id"),'">',htmlEncode(a.get("name")),"</option>\n        ")}),__p.push('\n        </optgroup>\n        <optgroup label="Only the following sprint">\n        ');var sprints=backlog.Sprints().sortBy(function(a){a.get("iteration")});_(sprints.reverse()).each(function(a){__p.push('\n          <option id="sprint-',a.get("id"),'">Sprint ',htmlEncode(a.get("iteration")),"</option>\n        ")}),__p.push('\n        </optgroup>\n      </select>\n      <br />\n    </p>\n    <p>\n      Please select your paper size\n    </p>\n    <p>\n      <select id="page-size">\n        <option id="A4"',$.cookie("page-size-default")=="A4"?" selected":"",'>A4</option>\n        <option id="LETTER"',$.cookie("page-size-default")=="LETTER"?" selected":"",'>Letter</option>\n      </select>\n      <br />\n    </p>\n    <p>\n      Which printer setting do you use for double-sided printing?\n    </p>\n    <p>\n      <select id="fold-side">\n        <option id="long"',$.cookie("fold-side-default")=="long"?" selected":"",'>Long side binding</option>\n        <option id="short"',$.cookie("fold-side-default")=="short"?" selected":"",'>Short side binding</option>\n      </select>\n      <br />\n    </p>\n    <p class="progress-placeholder">\n    </p>\n  </form>\n</div>\n')}return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/backlogs/sprint-progress-stats"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<h2 class="divider">Statistics</h2>\n\n<div class="loading">\n  <div class="icon">\n    <span class="progress-icon"></span>\n  </div>\n  <div class="notice">\n    Please wait while we load up your backlog statistics.\n  </div>\n</div>\n\n<div class="stats">\n  <div class="burn-down">\n    <div id="burn-down-chart" class="chart has-options"></div>\n    <div class="options">\n      <input type="checkbox" id="show-projected"><label for="show-projected">Show projected based on average velocity</label>\n    </div>\n  </div>\n\n  <div class="burn-up">\n    <div id="burn-up-chart" class="chart has-options"></div>\n    <div class="options"></div>\n  </div>\n\n  <div class="velocity">\n    <div id="velocity-chart" class="chart"></div>\n  </div>\n\n  <div class="average">\n    <h3>Velocity</h3>\n    <div class="box">\n      <table class="comparison">\n        <tr>\n          <th class="empty"></th>\n          <th>Average</th>\n          <th>Expected</th>\n        </tr>\n        <tr class="per-day">\n          <td>Velocity per day</td>\n          <td id="velocity-per-day-average"></td>\n          <td id="velocity-per-day-expected"></td>\n        </tr>\n        <tr>\n          <td>Velocity per sprint</td>\n          <td id="velocity-per-sprint-average"></td>\n          <td id="velocity-per-sprint-expected"></td>\n        </tr>\n      </table>\n\n      <div class="notice"></div>\n    </div>\n  </div>\n</div>\n\n<div class="no-stats">\n  <p>Unfortunately you have not yet completed a sprint, so there are no statistics available yet.</p>\n  <p>Once you have marked your first sprint as complete, statistics will appear in this area</p>\n  <div class="stats-placeholder"><div></div></div>\n</div>\n\n<div class="no-points">\n  <p>Unfortunately your backlog has not been assigned any points and as such there are no statistics available yet.</p>\n  <p>Once your backlog stories have been assigned points, statistics will appear in this area.</p>\n  <div class="stats-placeholder"><div></div></div>\n</div>\n'
);return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/backlogs/stats"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="title">',I18n.t("backlog_total"),':</div>\n<div class="output">\n  ',JST["templates/_shared/backlog_stats"]({model:model,useDaysEstimates:useDaysEstimates,useCostEstimates:useCostEstimates}),"\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/layouts/confirm-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-confirm" class="dialog" title="',title,'"}\n  <p>\n    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>\n    ',confirmationMessage,"\n  </p>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/snapshots/snapshot-header"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<td class="logo-space" colspan="',columns,'">\n  <a href="/" target="_blank" class="main-title">\n    <span class="easy">easy</span><span class="backlog">Backlog</span>\n  </a>\n  <span class="divider">|</span>\n  <b>Comparing Snapshots</b>\n</td>\n<td class="actions" colspan="',columns,'">\n  <a href="#help" id="help">Help?\n    <div id="help-rollover">\n      <div class="key"><span class="deleted"></span> Deleted from left</div>\n      <div class="key"><span class="new"></span> Added to right</div>\n      <div class="key"><span class="changed"></span> Value changed</div>\n      <div class="key"><span class="changed">▽</span> Value decreased</div>\n      <div class="key"><span class="changed">△</span> Value increased</div>\n    </div>\n  </a>\n  <span class="divider">|</span>\n  <a href="',document.location.href,'.xls">Export</a>\n  <span class="divider">|</span>\n  <a href="#print" id="print">Print</a>\n  <span class="divider">|</span>\n  <a href="#close-window" id="close-window">Close</a>\n</td>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/changed-confirm-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-changed-confirm" title="Discard changes?">\n  <form>\n    <p class="intro">\n      You have made changes.  Do you want to discard your changes?\n    </p>\n  </form>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/delete-sprint-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-delete-sprint" title="Delete sprint">\n  <form>\n    <p class="intro">\n      Are you sure you want to permanently delete sprint ',iteration,"?\n    </p>\n  </form>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/edit-sprint"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<form class="edit_sprint">\n  <div id="form-errors"></div>\n\n  <label for="start-on">Sprint start date</label>\n  <div class=\'label-hint\'>\n    (click to show the calendar)\n  </div>\n  <div class=\'input-row\'>\n    <input id="start-on" name="start_on" type="text" autocomplete="off">\n  </div>\n\n  <div class=\'label-spacer\'></div>\n\n  <label for="duration-days">Duration of sprint in days</label>\n  <div class=\'label-hint\'>\n    (typically working days)\n  </div>\n  <div class=\'input-row\'>\n    <input id="duration-days" name="duration_days" type="text" value="',model.get("duration_days"),'" class="narrow" autocomplete="off">\n  </div>\n\n  <div class=\'label-spacer\'></div>\n\n  '),backlog.get("velocity")?__p.push('\n    <div class=\'input-row question\'>\n      <label>How would you like the team velocity for this sprint to be determined?</label>\n    </div>\n\n    <div class=\'input-row\'>\n      <input type="radio" id="use-team-members" name="calculation_method">\n      <label for="use-team-members" id="use-explicit-velocity-false">Use backlog velocity of ',niceNum(backlog.get("velocity")),' points per person per day</label>\n    </div>\n\n    <div id="use-team-members-container">\n      <label for="number-team-members" class="light">Number of team members</label>\n      <div class=\'label-hint\'>\n        (working on this sprint completing stories)\n      </div>\n      <div class=\'input-row\'>\n        <input id="number-team-members" name="number_team_members" type="text" value="',niceNum(model.get("number_team_members")),'" class="narrow" autocomplete="off">\n      </div>\n      <div class=\'input-row\'>\n        Expected team velocity: <span id="expected-velocity">(unknown)</span>\n      </div>\n    </div>\n\n    <div class=\'input-row\'>\n      <input type="radio" id="use-explicit-velocity" name="calculation_method">\n      <label for="use-explicit-velocity" id="use-explicit-velocity-true">Manually define a team velocity for this sprint</label>\n    </div>\n\n    <div id="use-explicit-velocity-container">\n      <label for="explicit-velocity" class="light">Velocity in points</label>\n  '):__p.push('\n    <div class="input=row">\n      <label for="explicit-velocity">Team velocity for this sprint</label>\n      <div class=\'label-hint\'>\n        (in points)\n      </div>\n    </div>\n  '),__p.push('\n      <div class=\'input-row\'>\n        <input id="explicit-velocity" name="explicit_velocity" type="text" value="',niceNum(model.get("explicit_velocity")),'" class="narrow" autocomplete="off">\n      </div>\n  '),backlog.get("velocity")&&__p.push("\n    </div>\n  "),__p.push('\n\n  <div class=\'label-spacer\'></div>\n\n  <label>Sprint Status: This sprint is...</label>\n  <div class="form-box">\n    <div class="input-row">\n      <input type="radio" name="sprint_status" id="sprint_status_completed"',model.IsComplete()?' checked="checked"':"",'>\n      <label for="sprint_status_completed">Complete <span class="detail">— All stories are complete</span></label>\n    </div>\n    <div class="input-row">\n      <input type="radio" name="sprint_status" id="sprint_status_incomplete"',model.IsComplete()?"":' checked="checked"','>\n      <label for="sprint_status_incomplete">Incomplete <span class="detail">— currently a work in progress or being used for planning the next iteration</span></label>\n    </div>\n  </div>\n\n  <div class=\'label-spacer\'></div>\n\n  '),backlog.CanEdit()?__p.push('\n    <a id="sprint_submit" class="button" href="#update">Update sprint settings</a>\n    <a id="sprint_cancel" href="#cancel">cancel</a>\n  '):__p.push('\n    <a id="sprint_cancel" href="#cancel" class="button">← Back to backlog</a>\n  '),__p.push("\n</form>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/empty"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="notice">\n  Drag an unassigned story from the right hand side to allocate it to this sprint.\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/help-pod"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<section class="side-panel">\n  '),backlog.IsEditable()?__p.push('\n    <div class="button-container">\n      <a href="#" class="add-new-sprint button">Create new sprint</a>\n      <div class="button-help">\n        For future sprints, the Sprints tab above will no longer appear, so you must use the <b>+</b> icon next to the Backlog tab to add further sprints.\n      </div>\n    </div>\n  '):backlog.IsLocked()?__p.push('\n    <div class="backlog-tool-panel">\n      <h2>Sprints locked</h2>\n      This backlog is not editable and therefore no new sprints can be added.\n    </div>\n  '):backlog.CanEdit()||__p.push('\n    <div class="backlog-tool-panel">\n      <h2>Sprints not editable</h2>\n      You do not have permission to add or edit any sprints.\n    </div>\n  '),__p.push("\n\n</section>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/help"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<h2 class="divider">Sprints</h2>\n\n<p>\n  Once you are ready to start working on your backlog, you can create sprints and assign stories to those sprints.\n<p>\n\n\n<h3>First time using sprints?</h3>\n<p>\n  We\'d recommend you read the following key tips before you start:\n</p>\n<ul>\n  <li>Use the <b>+</b> symbol in the left hand tab to add a sprint at any stage.</li>\n  <li>When viewing a sprint, simply drag the stories from the right hand side into your sprint</li>\n  <li>You can also click on a story to move them quickly to the bottom of a sprint, or back to the backlog</li>\n  <li>Once allocated to a sprint, you can update the status of a story and finally mark it as <span style="color: #090">Done</span></li>\n  <li>A sprint can be marked as <span style="color: #090">Complete</span> once all stories within that sprint are <span style="color: #090">Done</span></li>\n  <li>Completed sprints and done stories are no longer editable in the backlog</li>\n  <li>You can change your sprint settings by clicking on the Settings button in the top right at any point</li>\n</ul>\n\n'),backlog.IsEditable()&&__p.push('\n  <a href="#" class="add-new-sprint button">Create new sprint</a>\n'),__p.push("\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/move-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-move-sprint-stories" title="Move sprint stories">\n  <form>\n    <div class="error-message"></div>\n    <p class="intro">\n      Where would you like to move all incomplete stories?\n    </p>\n    <p>\n      <select id="stories-target">\n        <option value="">Please choose a destination...</option>\n        <option value="backlog">Back to the backlog »</option>\n        '),_(sprints).each(function(a){__p.push('\n          <option value="',a.get("id"),'">« Sprint ',a.get("iteration"),"</option>\n        ")}),__p.push('\n      </select>\n    </p>\n    <p class="progress-placeholder"></p>\n  </form>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/new-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-new-sprint" title="Create a new sprint">\n  <form>\n    <p class="intro">\n      Each sprint must have a start date, a duration in working days and an expected velocity.  Please complete the fields below to set up your new sprint.\n    </p>\n    <p>\n      <div>\n        <table>\n          <tr>\n            <td class="space">\n              <label for="start-on">Sprint start date</label>\n              <br/>\n              <input id="start-on" name="start_on" type="text" autocomplete="off">\n            </td>\n            <td>\n              <label for="duration-days">Duration of sprint in working days</label>\n              <br />\n              <input id="duration-days" name="duration_days" type="text" autocomplete="off">\n            </td>\n          </tr>\n        </table>\n\n        <table>\n          '),backlog.get("velocity")&&__p.push('\n            <tr class="question">\n              <td colspan="2">\n                How would you like the team velocity for this sprint to be determined?\n              </td>\n            </tr>\n            <tr class="heading">\n              <td rowspan="3"><input type="radio" id="use-team-members" name="calculation_method"></td>\n              <td>\n                <label for="use-team-members" id="use-explicit-velocity-false">Use backlog velocity of ',niceNum(backlog.get("velocity")),' points per person per day</label>\n              </td>\n            </tr>\n            <tr class="sub-section use-team-members">\n              <td>\n                <label for="number-team-members">Enter your team size</label>\n                <div>\n                  <input id="number-team-members" name="number_team_members" type="text" autocomplete="off">\n                </div>\n              </td>\n            </tr>\n            <tr class="sub-section use-team-members">\n              <td>\n                <label>Expected team velocity:</label>\n                <div id="expected-velocity">(unknown)</div>\n              </td>\n            </tr>\n          '),__p.push('\n\n          <tr class="heading">\n            '),backlog.get("velocity")?__p.push('\n              <td rowspan="3"><input type="radio" id="use-explicit-velocity" name="calculation_method" autocomplete="off"></td>\n              <td>\n                <label for="use-explicit-velocity" id="use-explicit-velocity-true">Manually define a team velocity for this sprint</label>\n              </td>\n            '):__p.push('\n              <td><label for="explicit-velocity">Expected team velocity for this sprint</label></td>\n            '),__p.push('\n          </tr>\n          <tr class="sub-section use-explicit-velocity">\n            <td>\n              '),backlog.get("velocity")&&__p.push('\n              <label for="explicit-velocity">Velocity in points</label>\n              '),__p.push('\n              <div>\n                <input id="explicit-velocity" name="explicit_velocity" type="text">\n              </div>\n            </td>\n          </tr>\n        </table>\n      </div>\n    </p>\n    <p class="progress-placeholder"></p>\n  </form>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/show"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<h2 class="divider'),model.IsComplete()&&__p.push(" completed"),__p.push('">\n  Sprint ',model.get("iteration"),' stories\n</h2>\n\n<div class="all-stories">\n  <div class="stories-container">\n    <div class="cards story-droppable"></div>\n    <div class="totals"></div>\n    '),model.IsEditable()&&(__p.push('\n      <div class="complete-status">\n        '),model.IsComplete()?__p.push('\n          <a href="#incomplete" class="mark-sprint-as-incomplete button greyed">Mark sprint as incomplete</a>\n        '):(__p.push('\n          <a href="#complete" class="mark-sprint-as-complete button">Mark sprint as complete</a>\n          '),model.SprintStories().incompleteStories().length&&__p.push('\n          <a href="#move-stories" class="bulk-move-stories">move all incomplete stories</a>\n          '),__p.push("\n        ")),__p.push("\n      </div>\n    ")),__p.push('\n  </div>\n  <div class="unassigned-stories-heading">Backlog (unassigned stories)</div>\n  <div class="stories-divider">\n    <div class="handle"><div class="change-size">expand</div></div>\n  </div>\n  <div class="unassigned-stories-container story-droppable">\n    '),model.CanEdit()?model.IsComplete()&&__p.push('\n      <div class="read-only locked">\n        You cannot move any stories into a completed sprint\n      </div>\n    '):__p.push('\n      <div class="notice locked">\n        You cannot assign any stories to sprints as you don\'t have permission\n      </div>\n    '),__p.push("\n  </div>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/sprint-delete-panel"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="backlog-tool-panel">\n  '),model.CanEdit()?(__p.push("\n    <h2>Delete sprint</h2>\n    "),model.IsComplete()?__p.push("\n      This sprint is no longer editable as it is marked as complete.  If you need to delete this sprint, mark this sprint as incomplete.\n    "):model.get("deletable?")?__p.push('\n      Deleting a sprint immediately will remove all stories from this sprint and this sprint will be <b>permanently deleted</b>.\n      <b>There is no undo</b> so make sure you absolutely sure you want to delete this sprint.\n      <div class="button-container">\n        <a href="#delete-sprint" class="delete-sprint">Yes, I understand — delete this sprint</a>\n      </div>\n    '):__p.push("\n      This sprint cannot be deleted as it is not the last sprint.  You must delete all successive sprints before you can delete this sprint.\n    "),__p.push("\n  ")):__p.push("\n    <h2>Sprint read-only</h2>\n    You do not have permission to edit any of the settings of this backlog's sprint.\n  "),__p.push("\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/sprint-story"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="fields">\n  <div class="code">\n    <div class="heading">',I18n.t("id","ID"),':</div>\n    <div class="data">',model.Theme().get("code"),"",model.get("unique_id"),'</div>\n  </div>\n  <div class="points">\n    <div class="heading">',I18n.t("points_heading","Points"),':</div>\n    <div class="data">'),model.get("score_50")===model.get("score_90")?__p.push("\n        ",model.get("score_50")?niceNum(model.get("score_50")):"0","\n      "):(!model.get("score_50")&&!model.get("score_90")?__p.push("\n             0\n        "):__p.push("\n          ",model.get("score_50")?niceNum(model.get("score_50")):0,"/",model.get("score_90")?niceNum(model.get("score_90")):0,"\n        "),__p.push("\n      ")),__p.push('\n    </div>\n  </div>\n  <div class="status">\n    '),model.SprintStory()&&__p.push('\n      <div class="tab status-code-',model.SprintStory().Status().get("code"),'"><span>',model.SprintStory().Status().get("status").replace(" ","&nbsp;"),"</span></div>\n    "),__p.push('\n  </div>\n</div>\n\n<div class="story">\n  <div class="theme"><div class="heading">',I18n.t("theme","Theme"),':</div><div class="data">',htmlEncode(model.Theme().get("name")),'</div></div>\n  <div class="as-a"><div class="heading">',I18n.t("as_a","As"),' </div><div class="data">',htmlEncode(model.get("as_a")),'</div></div>\n  <div class="i-want-to"><div class="heading">',I18n.t("i_want_to","I want to"),' </div><div class="data">',multiLineHtmlEncode(model.get("i_want_to")),'</div></div>\n  <div class="so-i-can"><div class="heading">',I18n.t("so_i_can","So I can"),' </div><div class="data">',multiLineHtmlEncode(model.get("so_i_can")),'</div></div>\n</div>\n\n<div class="acceptance-criteria">\n  <ol>\n    '),model.AcceptanceCriteria().each(function(a){__p.push("\n      <li>",multiLineHtmlEncode(a.get("criterion")),"</li>\n    ")}),__p.push('\n  </ol>\n</div>\n\n<div class="more"><div class="tab"></div></div>\n\n<div class="move">move</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/stats"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="title">\n  ',I18n.t("sprint_total","Sprint total"),'\n</div>\n<div class="divider"></div>\n<div class="output'),Number(attributes.total_allocated_points)>Number(attributes.total_expected_points)&&__p.push(" highlight"),__p.push('">\n  ',addCommas((Number(attributes.total_allocated_points)||0).toFixed(1))," ",I18n.t("pts_allocated","pts allocated"),'\n</div>\n<div class="divider"></div>\n<div class="output">\n  ',addCommas((Number(attributes.total_expected_points)||0).toFixed(1))," ",I18n.t("pts_expected","pts expected"),'\n</div>\n<div class="divider"></div>\n<div class="output">\n  ',addCommas((Number(attributes.total_completed_points)||0).toFixed(1))," ",I18n.t("pts_completed","pts completed"),"\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/tabs/show"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push("<a>\n  ",model.get("iteration"),"\n</a>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/sprints/totals"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="title">\n  <span class="sprint-start-title">Sprint start:</span> ',$.datepicker.formatDate($.datepicker._defaults.dateFormat,parseRubyDate(sprint.get("start_on"))),'\n</div>\n\n<div class="amount'),Number(attributes.total_allocated_points)>Number(attributes.total_expected_points)&&__p.push(" highlight"),__p.push('">\n',addCommas((Number(attributes.total_allocated_points)||0).toFixed(1)),'\n</div>\n<div class="output'),Number(attributes.total_allocated_points)>Number(attributes.total_expected_points)&&__p.push(" highlight"),__p.push('">\n  Points in this sprint from the ',storyCount===1?storyCount+" story":storyCount+" stories",':\n</div>\n\n<div class="amount">\n',addCommas((Number(attributes.total_expected_points)||0).toFixed(1)),'\n</div>\n<div class="output">\n  Points expected in this sprint:\n</div>\n\n<div class="amount">\n',addCommas((Number(attributes.total_completed_points)||0).toFixed(1)),'\n</div>\n<div class="output">\n  Points completed:\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/stories/delete-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-delete" title="Delete story?">\n  <p>\n    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;" />\n    This story will be permanently deleted and cannot be recovered. Are you sure?\n  </p>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/stories/move-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-move-story" title="Move story">\n  <p>\n    <span class="ui-icon ui-icon-arrow-4" style="float:left; margin:0 7px 20px 0;" />\n    Move story \'',story.Theme().get("code")+story.get("unique_id"),'\' to which theme?\n  </p>\n  <p>\n    <form>\n    <select id="theme-target">\n      '),themes.each(function(a){__p.push('\n        <option id="',a.get("id"),'"',a==story.Theme()?' selected=""':"",">",a.get("name"),"</option>\n      ")}),__p.push("\n    </select>\n    </form>\n  </p>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/stories/new"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<li class="actions">\n  <a href="#new-story" class="new-story">Add story</a>\n</li>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/stories/show"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="background-color-indicator"></div>\n<div class="unique-id">\n  <div class="data">',model.Theme().get("code"),"",model.get("unique_id"),"</div>\n  "),model.IsEditable()&&__p.push('\n    <div class="story-actions">\n      <div class="color-picker-icon">\n        <a class="vtip" title="Assign a color"></a>\n      </div>\n      <div class="delete-story">\n        <a href="#delete-story" class="ui-icon ui-icon-trash vtip" title="Delete this story"></a>\n      </div>\n      <div class="duplicate-story">\n        <a href="#duplicate-story" class="ui-icon ui-icon-newwin vtip" title="Duplicate this story"></a>\n      </div>\n      <div class="move-story">\n        <a href="#move-story" class="vtip ui-icon ui-icon-arrow-4" title="Drag move to re-order this story, or click to move to another theme"></a>\n      </div>\n    </div>\n  '),__p.push('\n  <div class="sprint-story-info">\n    '),model.SprintStory()&&__p.push('\n      <div class="status">\n        <div class="tab status-code-',model.SprintStory().Status().get("code"),'"><span>',model.SprintStory().Status().get("status").replace(" ","&nbsp;"),"</span></div>\n      </div>\n    "),__p.push("\n    "),model.SprintStory()&&__p.push('\n      <div class="sprint"><div class="tab"><a href="#',model.SprintStory().Sprint().get("iteration"),'">',I18n.t("sprint_lower","sprint"),"&nbsp;",model.SprintStory().Sprint().get("iteration"),"</a></div></div>\n    "),__p.push('\n  </div>\n</div>\n<div class="user-story">\n  <div class="as-a"><div class="heading">',I18n.t("as_a","As"),' </div><div class="data">',htmlEncode(model.get("as_a")),'</div></div>\n  <div class="i-want-to"><div class="heading">',I18n.t("i_want_to","I want to"),' </div><div class="data">',multiLineHtmlEncode(model.get("i_want_to")),'</div></div>\n  <div class="so-i-can"><div class="heading">',I18n.t("so_i_can","So I can"),' </div><div class="data">',multiLineHtmlEncode(model.get("so_i_can")),'</div></div>\n</div>\n<div class="acceptance-criteria">\n</div>\n<div class="comments">\n  <div class="data">',urlify(multiLineHtmlEncode(model.get("comments")),35),"</div>\n</div>\n"),use5090Estimates?__p.push('\n<div class="score-50">\n  <div class="data">',niceNum(model.get("score_50")),'</div>\n</div>\n<div class="score-90">\n  <div class="data">',niceNum(model.get("score_90")),"</div>\n</div>\n"):__p.push('\n<div class="score">\n  <div class="data">',niceNum(model.get("score")),"</div>\n</div>\n"),__p.push("\n"),useCostEstimates&&__p.push('\n<div class="cost-formatted">\n  <div class="data">',model.get("cost_formatted"),"</div>\n</div>\n"),__p.push("\n"),useDaysEstimates&&__p.push('\n<div class="days-formatted">\n  <div class="data">',model.get("days_formatted"),"</div>\n</div>\n"),__p.push("\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/stories/status-drop-down"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="sprint-story-status-dropdown">\n  <ul>\n    '),App.Collections.SprintStoryStatuses.each(function(a){__p.push("\n      "),a.get("code")!==model.SprintStory().Status().get("code")&&__p.push('\n        <li id="status-id-',a.get("id"),'" class="status-code-',a.get("code"),'">',a.get("status"),"</li>\n      "),__p.push("\n    ")}),__p.push("\n  </ul>\n</div>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/themes/delete-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-delete" title="Delete theme?">\n  <p>\n    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;" />\n    This theme and all its stories will be permanently deleted and cannot be recovered. Are you sure?\n  </p>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/themes/index"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<ul class="themes">\n</ul>\n<div class="stop-ordering">\n  <a href="#stop-ordering">Stop ordering</a>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/themes/new"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<li class="actions">\n  <a href="#new-theme" class="new-theme">Add theme</a>\n  <a href="#reorder-themes" class="reorder-themes">Reorder themes</a>\n</li>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/themes/re-number-dialog"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div id="dialog-re-number" title="Re-number stories in this theme?">\n  <p>\n    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 40px 0;" />\n    Are you sure you want to sequentially re-number all the stories in this theme based on their order?  You cannot undo this.\n  </p>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/themes/show"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="theme-data">\n  <div class="name">\n    <div class="data">',htmlEncode(model.get("name")),'</div>\n  </div>\n  <div class="theme-actions">\n    <div class="delete-theme"><a href="#delete-theme" class="ui-icon ui-icon-trash vtip" title="Delete this theme"></a></div>\n    <div class="re-number-stories"><a href="#re-number-stories" class="ui-icon ui-icon-shuffle vtip" title="Re-number the stories in this theme"></a></div>\n  </div>\n  <div class="code">\n    <div class="heading">',I18n.t("code","Code"),':</div>\n    <div class="data">',htmlEncode(model.get("code")),'</div>\n  </div>\n</div>\n<div class="stories">\n  <div class="theme-stats">\n    <div>&nbsp;</div>\n  </div>\n</div>\n<div class="move-theme">\n  <div class="icon ui-icon ui-icon-arrow-4"></div>\n  <div class="instructions">Drag this to reorder this theme</div>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/themes/stats"]=function(obj){var __p=[],print=function(){__p.push.apply(__p,arguments)};with(obj||{})__p.push('<div class="container">\n  '),model.get("name")&&model.get("name").length&&__p.push('\n    <div class="title">\n      ',I18n.t("theme_total","Total for theme '%{name}'").replace("%{name}",htmlEncode(model.get("name"))),"\n    </div>\n  "),__p.push('\n  <div class="metrics">\n    ',JST["templates/_shared/backlog_stats"]({model:model,useDaysEstimates:useDaysEstimates,useCostEstimates:useCostEstimates}),"\n  </div>\n</div>\n");return __p.join("")}}.call(this);